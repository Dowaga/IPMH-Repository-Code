---
title: "IPMH: Integration of stepped care for perinatal mood and anxiety disorders among women attending MCH clinics"

subtitle: 'Data and Safety Monitoring Board (DSMB): Closed Report '
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document
    #pdf_document:
    #latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, options(scipen = 0))

rm(list = ls())             

# Reference source codes & other dependencies:
source("DataTeam_ipmh.R")
# source("Dependencies.R")

pacman::p_load(flextable, officer, redcapAPI, magrittr, zoo, openxlsx, png, knitr, DiagrammeR, tidyverse, eeptools, 
               haven, reshape2, here, Hmisc, anthro, devtools, kableExtra, foreign,gdata, httr, table1, compareGroups, 
               janitor, gmodels, data.table, consort, flowchart, officer, webshot2, rmarkdown, gt, gtExtras, gtsummary,
               writexl, tidyr, tibble, purrr, patchwork, officedown, flextable, googledrive, googlesheets4, readxl)


## WORKING DIRECTORY
# Setup ------------------------------------------------------------------------

###########################################################################################

#### Note to analyst: change "analysis" to "Not Test"  in the faketreatment_helper.R script to run with actual treatment group data

###########################################################################################

# Set latex options (+latex troubleshooting)
# options(tinytex.verbose = TRUE)
# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::reinstall_tinytex()

# Set file paths: Use this section to set input and output filepaths
file_date <- list.files(path = paste0(ipmh_filepath, "/Data/6. RCT PPW data/"), pattern = "*.csv")
file_date <- str_replace(file_date, "-Yuwei's MacBook Pro", "")
file_date <- str_replace(file_date, "RCT_PPW_", "")
file_date <- str_replace(file_date, ".csv", "")
file_date <- max(file_date)
# file_date <- format(file_date, format="%d %B %Y")
ppw_rct_df <- read.csv(paste0(ipmh_filepath, "/Data/6. RCT PPW data/RCT_PPW_", 
                              file_date, ".csv", sep="")) %>% 
    filter(is.na(redcap_repeat_instance)) #PPW data

daily_closeout_df <- read.csv(paste0(ipmh_filepath, "/Data/7. RCT admin data/Daily_closeout_", 
                                     file_date, ".csv", sep=""))

screening_consent_df <- read.csv(paste0(ipmh_filepath, 
                                        "/Data/2. Consenting database/RCT_PPW_consenting_", 
                                        file_date, ".csv", sep=""))

pm_survey_df <- read.csv(paste0(ipmh_filepath, "/Data/7. RCT admin data/PM_", 
                                file_date, ".csv", sep="" ))

ppw_sae_df <- read.csv(paste0(ipmh_filepath, "/Data/6. RCT PPW data/RCT_PPW_", 
                                             file_date, ".csv", sep="")) %>% 
    filter(redcap_repeat_instrument == "ADMIN: Adverse Experience")

# reading in additional needed dataframes so that we don't need to import from REDCap each time report is run
telepsych <- read.csv(paste0(ipmh_filepath,"/Data/7. RCT admin data/Telepsych_",Sys.Date(),".csv"))
rct_ppw_consenting <- read.csv(paste0(ipmh_filepath,"/Data/2. Consenting database/RCT_PPW_consenting_",
                                      Sys.Date(),".csv"))


data_freeze <- file_date

data_freeze <- format(as.Date(data_freeze), format="%d %B %Y")
options(scipen = 0)
```


```{r logo,  out.width = "100%", echo=FALSE, eval = T, fig.height=4, fig.width=4}

knitr::include_graphics(paste0(file.path(ipmh_filepath, "/Data/IPMH logo.jpg")))

```


\newpage

John Kinuthia, MBChD, MMed, MPH, Kenyatta National Hospital

Keshet Ronen, PhD, MPH, University of Washington

Amritha Bhat, MBBS, MD, MPH, University of Washington

Report prepared by: David Owaga

Date of data freeze: `r data_freeze`

\newpage

# 1. Study summary

```{r study_summary}
vars <- c("Primary Objective", "Study Design", "Study Population", "Inclusion Criteria",
          "Target Sample Size",
          "Actual Enrollment",
          "Participants Completed Follow-up", "Duration", 
          "Date Study Open", "Date of First Complete Enrollment",
          "Estimated End of Study",
          "Endpoints", "")

vars2 <- c("Integrate IPMH, a stepped care intervention for screening and treatment of perinatal mood and anxiety disorders (PMADs), and its implementation strategies, into maternal and child health clinics and pragmatically evaluate its clinical, service delivery, and implementation outcomes",
           "A 2-arm, non-blinded cluster randomized controlled trial (RCT) comparing the effect of IPMH and associated implementation strategies on depression, anxiety, quality of life, and adverse perinatal outcomes vs. control (standard of care) among Kenyan women", 
           "Pregnant Kenyan women", 
           "-Receiving antenatal care at study facility\n->=28 weeks gestation (changed to >=20 weeks gestation\n-Age>=14\n-screen positive for PMAD symptoms (PHQ-2>=3 and/or GAD-2>=3)", 
           "2970, including 405 women living with HIV (WLWH)", 
           "[place holder]",
           "0",
           "Follow-up through 6 months postpartum", 
           "September 19, 2023", 
           "February 17, 2025",
           "July 31, 2028",
           "Primary: Depression and anxiety", 
           "Secondary:\n-Depression and anxiety among WLWH\n-Quality of Life\n-Adverse perinatal outcomes")

stdy_summ <- data.frame(vars, vars2)

study_summary <- flextable(stdy_summ)
study_summary <- flextable::width(study_summary, 'vars2', width = 5)
study_summary <- flextable::width(study_summary, 'vars', width = 2)
border <- fp_border()
study_summary <- flextable::vline(study_summary, j = c('vars'), border = border, part = "all")
study_summary <- set_header_labels(study_summary, vars = "Title", vars2 = "IPMH: Integration of stepped care for perinatal mood and anxiety disorders among women attending MCH clinics")

study_summary
```

\newpage
# 2. Study Enrollment

```{r Consort,echo=FALSE, fig.height=12, fig.width=15, message=FALSE, warning=FALSE}
# source("Consort.R")

#data prep ----------------
# Summarise ANC attendees and extract the sum as a numeric value
Attendees <- daily_closeout_df %>%
    summarise(`anc attendees` = sum(rct_anc_number, na.rm = TRUE)) %>%
    pull(`anc attendees`)  # Extract the sum value as a number

# Create a new data frame with anc_count rows, value = "Yes"
anc_attendees_df <- data.frame(
    anc_id = paste0("anc_", seq_len(Attendees)),
    anc_attendees = rep("Yes", Attendees)
)

#Study participants in the PM+ Survey
pm_abstractions <- pm_survey_df %>%
    mutate(pm_ptid = as.numeric(pm_ptid)) %>%       # if needed
    filter(ipmh_participant == "Yes") %>%
    distinct(pm_ptid, .keep_all = TRUE)

pm_df <- pm_abstractions %>% 
    select(pm_ptid, ipmh_participant)

# telepsy
#telepsych <- telepsych %>%
    #mutate(tele_ancid = if_else(row_number() == 1, 
                                #tele_ancid[4], tele_ancid))


telepsych_df <- telepsych %>%
    #filter(pt_attend == "Yes") %>%               # keep only attended
    arrange(tele_ancid, tele_date) %>%            # sort by person and date
    #Offered telepyschaitry as treatment but not referred
    filter(!tele_ancid == "2025-03-0092") %>%
    group_by(tele_ancid) %>%
    slice(1) %>%                                 # keep first record per person
    ungroup()

#now match this with consenting database to get their pt_id
tele_with_id <- telepsych_df %>%
    left_join(
        rct_ppw_consenting %>% 
            select(anc_num, partipant_id),
        by = c("tele_ancid" = "anc_num")
    )

tele_with_id <- tele_with_id %>%
    select(tele_ancid, partipant_id) %>% 
    mutate(tele = "Yes") 

tele_sessions <-tele_with_id %>% 
    nrow()

# Records that do not match with consent database
no_match <- tele_with_id %>% 
    filter(is.na(partipant_id))
    
telepsy_unmatched <- telepsych %>%
    filter(tele_ancid %in% no_match$tele_ancid)


# merging data
consort_data <- screening_consent_df %>% 
    select(record_id, partipant_id, rct_harm_thought, rct_aud_hallucinations, 
           rct_vis_hallucinations, rct_paranoia,rct_delusions,
           rct_memory_problem,rct_eligible_gestation, rct_eligible_harm, 
           rct_risk, rct_eligible, rct_enrolling, rct_decline_reason, 
           rct_other_reasons) %>% 
    mutate(
        eligible = case_when(
            rct_eligible == 1 ~ "1",
            TRUE ~ NA_character_)) %>% 
    mutate(exclusion = case_when(
        rct_eligible == 0 & rct_eligible_gestation == "No" ~ "Gestation <20 Weeks",
        rct_harm_thought == "Yes" & rct_memory_problem == "No" ~"Self harm",
        rct_harm_thought == "Yes" & rct_memory_problem == "Yes" ~"Self harm and memory problem",
        rct_eligible == 0 & rct_aud_hallucinations == "Yes" ~ "Hearing voices that others cannot hear",
        rct_eligible == 0 & rct_vis_hallucinations == "Yes" ~"Seeing things that others cannot see",
        rct_memory_problem == "Yes" ~"Memory problem",
        rct_delusions == "Yes" ~ "Holding unusual beliefs",
        rct_paranoia == "Yes" ~ "Feels watched/followed",
                TRUE ~ NA_character_)) %>% 
    mutate(
        exclusion = case_when(
            eligible == 1 & exclusion == "Self harm" & rct_risk %in% c("Low", "Moderate") ~ NA_character_,
            TRUE ~ exclusion
              )) %>% 
    mutate(facility = as.numeric(str_sub(partipant_id, 3, 4))) %>% 
    mutate(arm = case_when(
        facility %in% c(2, 5, 6, 8, 11, 14, 15, 18, 20, 21) ~ "Control",
        TRUE ~ "Intervention"
    )) %>% 
    mutate(rct_decline_reason = case_when(
            rct_decline_reason == "Other (specify) ___" ~ "Relocate post delivery",
            TRUE ~ rct_decline_reason  # Keep other values unchanged
        )) 


# Merge consort data with pm_df
consort_data <- consort_data %>% 
    left_join(pm_df, by = c("partipant_id"="pm_ptid"))

consort_data <- bind_rows(anc_attendees_df, consort_data)

elig <- consort_data %>% 
    filter(is.na(eligible)) %>% 
    filter(is.na(exclusion))

decline_reason <- consort_data %>% 
    filter(!is.na(rct_decline_reason))

secondvisit <- ppw_rct_df %>% 
    filter(clt_visit == "6 weeks post-partum") %>% 
    select(clt_ptid) %>% 
    mutate(secondvisit = "Yes") 

thirdvisit <- ppw_rct_df %>% 
    filter(clt_visit == "14 weeks post-partum") %>% 
    select(clt_ptid) %>% 
    mutate(thirdvisit = "Yes") 


fourthvisit <- ppw_rct_df %>% 
    filter(clt_visit == "6 months post-partum") %>% 
    select(clt_ptid) %>% 
    mutate(fourthvisit = "Yes") 

# merge secondvisit people into consort_data
consort_data <- consort_data %>% 
    left_join(secondvisit, by = c("partipant_id" = "clt_ptid")) 

consort_data <- consort_data %>% 
    left_join(tele_with_id, by = c("partipant_id" = "partipant_id")) 


#merge thirdvisit people into consort_data
consort_data <- consort_data %>% 
    left_join(thirdvisit, by = c("partipant_id" = "clt_ptid"))

# merge fourthvisit people into consort_data
consort_data <- consort_data %>% 
    left_join(fourthvisit, by = c("partipant_id" = "clt_ptid"))

# Create a dummy arm for DSMB Closed report
consort_data <- consort_data %>% 
    mutate(
        dummy_arm = case_when(
            is.na(arm) ~ NA_character_,        # keep NA as NA
            grepl("Control", arm) ~ "Arm X",   # if arm contains "Control"
            TRUE ~ "Arm Y"                     # everything else
        ))



# build consort diagram
counts_by_arm <- consort_data %>%
    filter(!is.na(arm)) %>%
    group_by(arm) %>%  
    summarise(
        assessed = n(),
        excluded = sum(!is.na(exclusion)),
        eligible = sum(eligible == 1, na.rm = TRUE),
        enrolled = sum(rct_enrolling == "Yes", na.rm = TRUE),
        pm_participants = sum(ipmh_participant == "Yes", na.rm = TRUE),
        tele_participants = sum(tele == "Yes", na.rm = TRUE),
        postpartum_visit = sum(secondvisit == "Yes", na.rm = TRUE),
        postpartum_visit1 = sum(thirdvisit == "Yes", na.rm = TRUE),
        postpartum_visit2 = sum(fourthvisit == "Yes", na.rm = TRUE)
    )

# Function to generate stage text
generate_stage_text <- function(stage_label, numerator, denominator, decimals = 2) {
    percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
    sprintf("%s\n (n=%d, %.*f%%)", stage_label, numerator, decimals, percent)
}

# Apply to each arm
counts_by_arm <- counts_by_arm %>%
    rowwise() %>%
    mutate(
        txt_eligible = generate_stage_text("Eligible", eligible, assessed),
        txt_excluded = generate_stage_text("Excluded", excluded, assessed),
        txt_enrolled = generate_stage_text("Enrolled", enrolled, eligible),
        txt_pm = generate_stage_text("PM+", pm_participants, enrolled),
        txt_tele = generate_stage_text("Telepsychiatry", tele_participants, enrolled),
        txt_postpartum = generate_stage_text("6 weeks postpartum visit", postpartum_visit, enrolled),
        txt_postpartum1 = generate_stage_text("14 weeks postpartum visit", postpartum_visit1, enrolled),
        txt_postpartum2 = generate_stage_text("6 months postpartum visit", postpartum_visit2, enrolled)
    )

# Total text for ANC attendees
n_attendees <- consort_data %>% filter(anc_attendees == "Yes") %>% nrow()
txt_anc <- sprintf("ANC Attendees (n=%d)", n_attendees)

# Total assessment
n_assessed <- consort_data %>% filter(!is.na(arm)) %>% nrow()
txt_ass <- sprintf("Assessed for Eligibility\n (n=%d, %.1f%%)", n_assessed, (n_assessed / n_attendees) * 100)

txt_arm <- counts_by_arm %>%
    mutate(txt = sprintf("%s\n (n=%d, %.1f%%)", arm, assessed, (assessed / n_assessed) * 100)) %>%
    pull(txt)

#combine PM+ and telepsychiatry
counts_by_arm <- counts_by_arm %>%
    mutate(txt_pm_tele = paste(txt_pm, txt_tele, sep = "\n"))

generate_box_header <- function(label, numerator, denominator, decimals = 2) {
percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
sprintf("%s (n=%d, %.*f%%):", label, numerator, decimals, percent)
}

# Build exclusion string per arm
exclusion_side_boxes <- consort_data %>%
    filter(!is.na(exclusion)) %>%
    group_by(arm, exclusion_reason = exclusion) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>% select(arm, excluded, assessed),
        by = "arm"
    ) %>%
    group_split(arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$arm)
        excluded <- unique(df_arm$excluded)
        assessed <- unique(df_arm$assessed)
        
        # Header line (no real line break)
        header <- generate_box_header("Excluded", excluded, assessed)
        
        # Bullet lines (keep \\n as character)
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / excluded) * 100)
            },
            df_arm$exclusion_reason,
            df_arm$count
        )
        
        # Combine header + bullets with literal \n characters
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_ex <- unlist(exclusion_side_boxes)

# Build decline side boxes per arm
decline_side_boxes <- consort_data %>%
    filter(!is.na(rct_decline_reason)) %>%
    group_by(arm, decline_reason = rct_decline_reason) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>%
            mutate(declined = eligible - enrolled) %>%
            select(arm, declined, eligible),
        by = "arm"
    ) %>%
    group_split(arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$arm)
        declined <- unique(df_arm$declined)
        eligible <- unique(df_arm$eligible)
        
        # Header line (with real line break later)
        header <- sprintf("Declined Enrollment (n=%d, %.1f%%):", declined, (declined / eligible) * 100)
        
        # Bullet lines with Unicode bullets and percentages
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / declined) * 100)
            },
            df_arm$decline_reason,
            df_arm$count
        )
        
        # Combine header + bullets with **real line breaks**
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_decline <- unlist(decline_side_boxes)

consort_per <- add_box(txt = txt_anc) |>
    add_box(txt = txt_ass) |>
    add_split(txt = txt_arm) |>
    add_side_box(txt = txt_ex) |>
    add_box(txt = counts_by_arm$txt_eligible) |>
    add_side_box(txt = txt_decline) |>
    add_box(txt = counts_by_arm$txt_enrolled) |>
    #add_side_box(txt= counts_by_arm$txt_pm_tele) |>
    add_box(txt = counts_by_arm$txt_postpartum)|>
    add_box(txt = counts_by_arm$txt_postpartum1)|>
    add_box(txt = counts_by_arm$txt_postpartum2)

consort_per
```

\newpage
## 2.2  Enrollment Progress

## 2.2.1  Enrollment Progress - Overall

```{r enrollment_progress, fig.width=12, fig.height=10, echo=FALSE}
# source("Enrollment Progress.R")

## Figure 1: Enrollment progress since the beginning of the study to today
enrollment_progress <- screening_consent_df %>% 
    filter(rct_enrolling == "Yes"| latest_consent == 
               'Yes') %>% 
    select(study_site, consent_date_auto, consent_date_auto_v2)


## 
enrollment_progress <- enrollment_progress %>%
    mutate(consent_date_auto = coalesce(consent_date_auto, consent_date_auto_v2)) %>%
    select(study_site, consent_date_auto)

## Convert consent_date_auto column to date format
enrollment_progress <- enrollment_progress %>%
    mutate(consent_date_auto = as.Date(consent_date_auto, origin = "1899-12-30"))

# Aggregate weekly enrollments per site
weekly_count <- enrollment_progress %>%
    mutate(week = floor_date(consent_date_auto, "week", week_start = 1)) %>%  # Group by week
    group_by(study_site, week) %>%
    summarise(enrollment_count = n(), .groups = "drop")  # Count enrollments

# Define the sequence of weekly dates (assuming enrollment started on 2025-02-17)
date_seq <- seq(as.Date("2025-02-16"), as.Date("2025-03-29"), by = "week", week_start = 1)

date_seq <- seq(
    from = as.Date("2025-02-16"),
    to = Sys.Date(),
    by = "week"
)

# Convert to a dataframe
dateSeq_df <- data.frame(week = date_seq)

weekly_enrollment <- full_join(weekly_count, dateSeq_df, by = "week") %>%
    arrange(week) %>%  # Ensure weeks are in order
    mutate(enrollment_count = ifelse(is.na(enrollment_count), 
                                     0, enrollment_count)) %>%   # Fill missing counts with 0
    filter(!is.na(study_site))

# Compute cumulative enrollment per site
weekly_enrollment <- weekly_enrollment %>%
    group_by(study_site) %>%
    mutate(cumulative_enrollment = cumsum(enrollment_count)) %>%
    ungroup()


#shorten the names of the study sites
weekly_enrollment <- weekly_enrollment %>%
  mutate(study_site = recode(study_site,
    "01, Rwambwa Sub-county Hospital" = "01, Rwambwa",
    "02, Sigomere Sub County Hospital" = "02, Sigomere",
    "03, Uyawi Sub County Hospital" = "03, Uyawi",
    "04, Got Agulu Sub-District Hospital" = "04, Got Agulu",
    "05, Ukwala Sub County Hospital" = "05, Ukwala",
    "06, Madiany Sub County Hospital" = "06, Madiany",
    "07, Kabondo Sub County Hospital" = "07, Kabondo",
    "08, Mbita Sub-County Hospital" = "08, Mbita",
    "09, Miriu Health Centre" = "09, Miriu",
    "11, Nyandiwa Level IV Hospital" = "11, Nyandiwa",
    "13, Ober Kamoth Sub County Hospital" = "13, Ober Kamoth",
    "14, Gita Sub County Hospital" = "14, Gita",
    "15, Akala Health Centre" = "15, Akala",
    "16, Usigu Health Centre" = "16, Usigu",
    "17, Ramula Health Centre" = "17, Ramula",
    "18, Simenya Health Centre" = "18, Simenya",
    "19, Airport Health Centre (Kisumu)" = "19, Airport",
    "20, Nyalenda Health Centre" = "20, Nyalenda",
    "21, Mirogi Health Centre" = "21, Mirogi",
    "22, Ndiru Level 4 Hospital" = "22, Ndiru"
  )) 

# Create target line repeated for each arm_group
arm_groups <- unique(weekly_enrollment %>%
                       mutate(arm = stringr::str_extract(study_site,"^\\d{2}"),
                              arm_group = ifelse(arm %in% c("02","05", "06", "08", "11", "14", "15", "18", "20", "22"),
                                                 "Control", "Intervention")) %>%
                       pull(arm_group) %>%
                       unique())

<<<<<<< HEAD
target_25_line <- expand.grid(
  week = unique(weekly_enrollment$week),
  arm_group = arm_groups
) %>%
  mutate(
    cumulative_enrollment = 74,
    study_site = "25% Target"
  )

target_25_line <- expand.grid(week = unique(weekly_enrollment$week),
                              arm_group = arm_groups) %>%
  mutate(cumulative_enrollment = 372,
         study_site = "25% Target")


weekly_enrollment <- weekly_enrollment %>%
  mutate(arm = stringr::str_extract(study_site, "^\\d{2}"),
         arm_group = ifelse(arm %in% c("01", "02", "03", "04", "05", "06", "07"),
                       "Control", "Intervention"))

total_enrollment <- weekly_enrollment %>%
  group_by(week, arm_group) %>%
  summarise(enrollment_count = sum(enrollment_count), .groups = "drop") %>%
  arrange(week) %>%
  group_by(arm_group) %>%
  mutate(cumulative_enrollment = cumsum(enrollment_count)) %>%
  mutate(study_site = "Total")

combined_enrollment <- bind_rows(weekly_enrollment, total_enrollment, target_25_line)
    # mutate(dummy_arm = case_when(
    #        arm_group == "Control" ~ "Arm X",
    #        arm_group == "Intervention" ~ "Arm Y"))

p1 <- ggplot(combined_enrollment, aes(x = week, y = cumulative_enrollment, 
                                      color = study_site, group = study_site)) +
  geom_line(aes(linewidth = ifelse(study_site == "Total", 1.5, 0.5))) +
  scale_linewidth_identity() +
  facet_wrap(~ arm_group, ncol = 1) +  # one panel per arm
  labs(
    title = "Enrollment Trends by Study Arm",
    x = "Date",
    y = "Cumulative Enrollment",
    color = "Study Site"
  ) +
# Apply your professional theme
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    legend.position = "right",
    legend.box = "vertical",
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 9),
    legend.key.height = unit(0.5, "cm"),
    legend.key.width = unit(0.5, "cm"),
    plot.margin = margin(10, 20, 10, 10)
  ) +
  guides(color = guide_legend(ncol = 2)) +  # arrange legend in 2 columns +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y")

p1

```


\newpage

### 2.2.2 Enrollment Progress - Per Facility
```{r Facility target reached}
# source("Enrollment Progress.R")
reached_25per_target <- weekly_enrollment %>%
  group_by(study_site) %>%
  summarise(latest_enrollment = max(cumulative_enrollment, na.rm = TRUE)) %>%
  filter(latest_enrollment >= 37) %>%
  summarise(n = n()) %>%
  pull(n)

```

All (`r reached_25per_target`) facilities have surpassed our first enrollment milestone, with more than 37 perinatal women enrolled per facility cluster - exceeding 25% of the overall target enrollment. Nyalenda was the first facility to achieve this milestone in mid-April 2024.

```{r enrollment_sub_facility, fig.width=12, fig.height=10, echo=FALSE}
# source("Enrollment Progress.R")

#shorten the names of the study sites
# weekly_enrollment <- weekly_enrollment %>%
#   mutate(study_site = recode(study_site,
#     "01, Rwambwa Sub-county Hospital" = "01, Rwambwa",
#     "02, Sigomere Sub County Hospital" = "02, Sigomere",
#     "03, Uyawi Sub County Hospital" = "03, Uyawi",
#     "04, Got Agulu Sub-District Hospital" = "04, Got Agulu",
#     "05, Ukwala Sub County Hospital" = "05, Ukwala",
#     "06, Madiany Sub County Hospital" = "06, Madiany",
#     "07, Kabondo Sub County Hospital" = "07, Kabondo",
#     "08, Mbita Sub-County Hospital" = "08, Mbita",
#     "09, Miriu Health Centre" = "09, Miriu",
#     "11, Nyandiwa Level IV Hospital" = "11, Nyandiwa",
#     "13, Ober Kamoth Sub County Hospital" = "13, Ober Kamoth",
#     "14, Gita Sub County Hospital" = "14, Gita",
#     "15, Akala Health Centre" = "15, Akala",
#     "16, Usigu Health Centre" = "16, Usigu",
#     "17, Ramula Health Centre" = "17, Ramula",
#     "18, Simenya Health Centre" = "18, Simenya",
#     "19, Airport Health Centre (Kisumu)" = "19, Airport",
#     "20, Nyalenda Health Centre" = "20, Nyalenda",
#     "21, Mirogi Health Centre" = "21, Mirogi",
#     "22, Ndiru Level 4 Hospital" = "22, Ndiru"
#   )) %>%
#   mutate(
#     arm = stringr::str_extract(study_site, "^\\d{2}"),
#     arm_group = ifelse(arm %in% c("02", "05", "06", "08", "11", "15", "18", "20", "21"),
#                        "Arm X", "Arm Y")
#   )

p2 <- ggplot(weekly_enrollment, aes(x = week, y = cumulative_enrollment, 
                                    color = study_site, group = study_site)) +
  geom_line(linewidth = 1) +  
  geom_hline(yintercept = 37, linetype = "dashed", color = "blue", linewidth = 1.5) +
  annotate("text", x = min(weekly_enrollment$week), y = 37.125, 
           label = "25% Target", vjust = -1, hjust = 0, size = 3) +
  labs(title = "Enrollment Trends by Study Arm",
       x = "Date",
       y = "Cumulative Enrollment",
       color = "Study Site") +
  facet_wrap(~ arm_group, ncol = 1) +  # ??? facet by arm_group
  theme_minimal() +
  theme(
    legend.position = "left",
    legend.box = "vertical",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    strip.text = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)  # Center and bold title
  ) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b %Y")


p2
```

\newpage

# 3. WLWH Cohort

## 3.1 Current subject status

```{r consortnumsource, echo=FALSE, fig.height=4, fig.width=8, message=FALSE, warning=FALSE}
source("Consort_WLWH.R")
```

Overall `r n_enrolled` participants have been enrolled into the study, of which `r n_hiv` women are living with HIV (WLHIV), accounting to `r round(n_hiv/n_enrolled*100, 1)`% of total enrollments. Of these, `r six_weeks` (`r round(six_weeks/n_hiv *100,1 )`%) have completed their 6 weeks, `r fourteen_weeks` (`r round(fourteen_weeks/n_hiv*100,1)`%) have completed 14 weeks, and `r six_months` (`r round(six_months/n_hiv*100,1)`%) have completed their 6 months postpartum follow-up visits. 

```{r consort_WLWHIV, echo=FALSE, fig.height=10, fig.width = 15, message = FALSE, warning = FALSE}
# source("Consort_WLWH.R")

counts_by_arm <- consort_data %>%
    filter(!is.na(arm)) %>%
    group_by(arm) %>%
    summarise(
        assessed = n(),
        excluded = sum(!is.na(exclusion)),
        eligible = sum(eligible == 1, na.rm = TRUE),
        enrolled = sum(rct_enrolling == "Yes", na.rm = TRUE),
        hiv = sum(WLWH == "Yes", na.rm = TRUE),
        pm_participants = sum(ipmh_participant == "Yes" & WLWH == "Yes", na.rm = TRUE),
        tele_participants = sum(tele == "Yes" & WLWH == "Yes", na.rm = TRUE),
        six_weeks_visit = sum(secondvisit == "Yes" & WLWH == "Yes", na.rm = TRUE),
        fourteen_weeks_visit = sum(thirdvisit == "Yes" & WLWH == "Yes", na.rm = TRUE),
        six_months_visit = sum(fourthvisit == "Yes" & WLWH == "Yes", na.rm = TRUE)
    )

# Function to generate stage text
generate_stage_text <- function(stage_label, numerator, denominator, decimals = 2) {
    percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
    sprintf("%s\n (n=%d, %.*f%%)", stage_label, numerator, decimals, percent)
}

# Apply to each arm
counts_by_arm <- counts_by_arm %>%
    rowwise() %>%
    mutate(
        txt_eligible = generate_stage_text("Eligible", eligible, assessed),
        txt_excluded = generate_stage_text("Excluded", excluded, assessed),
        txt_enrolled = generate_stage_text("Enrolled", enrolled, eligible),
        txt_hiv = generate_stage_text("HIV+ (WLWH)", hiv, enrolled),
        txt_pm = generate_stage_text("PM+", pm_participants, hiv),
        txt_tele = generate_stage_text("Telepsychiatry", tele_participants, hiv),
        txt_6weeks_postpartum = generate_stage_text("6 weeks postpartum visit", six_weeks_visit, hiv),
        txt_14weeks_postpartum = generate_stage_text("14 weeks postpartum visit", fourteen_weeks_visit, hiv),
        txt_6months_postpartum = generate_stage_text("6 months postpartum visit", six_months_visit, hiv)
    )

# Total text for ANC attendees
txt_anc <- sprintf("ANC Attendees (n=%d)", n_attendees)

# Total assessment
txt_ass <- sprintf("Assessed for Eligibility\n (n=%d, %.1f%%)", n_assessed, (n_assessed / n_attendees) * 100)

txt_arm <- counts_by_arm %>%
    mutate(
        txt = sprintf("%s\n (n=%d, %.1f%%)", arm, assessed, (assessed / n_assessed) * 100)
    ) %>%
    pull(txt)

#combine PM+ and telepsychiatry
counts_by_arm <- counts_by_arm %>%
    mutate(
        txt_pm_tele = paste(txt_pm, txt_tele, sep = "\n")
    )

generate_box_header <- function(label, numerator, denominator, decimals = 2) {
    percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
    sprintf("%s (n=%d, %.*f%%):", label, numerator, decimals, percent)
}

# Build exclusion string per arm
exclusion_side_boxes <- consort_data %>%
    filter(!is.na(exclusion)) %>%
    group_by(arm, exclusion_reason = exclusion) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>% 
            select(arm, excluded, assessed),
        by = "arm"
    ) %>%
    group_split(arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$arm)
        excluded <- unique(df_arm$excluded)
        assessed <- unique(df_arm$assessed)
        
        # Header line (no real line break)
        header <- generate_box_header("Excluded", excluded, assessed)
        
        # Bullet lines (keep \\n as character)
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / excluded) * 100)
            },
            df_arm$exclusion_reason,
            df_arm$count
        )
        
        # Combine header + bullets with literal \n characters
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_ex <- unlist(exclusion_side_boxes)

# Build decline side boxes per arm
decline_side_boxes <- consort_data %>%
    filter(!is.na(rct_decline_reason)) %>%
    group_by(arm, decline_reason = rct_decline_reason) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>%
            mutate(declined = eligible - enrolled) %>%
            select(arm, declined, eligible),
        by = "arm"
    ) %>%
    group_split(arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$arm)
        declined <- unique(df_arm$declined)
        eligible <- unique(df_arm$eligible)
        
        # Header line (with real line break later)
        header <- sprintf("Declined Enrollment (n=%d, %.1f%%):", declined, (declined / eligible) * 100)
        
        # Bullet lines with Unicode bullets and percentages
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / declined) * 100)
            },
            df_arm$decline_reason,
            df_arm$count
        )
        
        # Combine header + bullets with **real line breaks**
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_decline <- unlist(decline_side_boxes)

consort_per <- add_box(txt = txt_anc) |>
    add_box(txt = txt_ass) |>
    add_split(txt = txt_arm) |>
    add_side_box(txt = txt_ex) |>
    add_box(txt = counts_by_arm$txt_eligible) |>
    add_side_box(txt = txt_decline) |>
    add_box(txt = counts_by_arm$txt_enrolled) |>
    add_box(txt = counts_by_arm$txt_hiv) |>
    #add_side_box(txt= counts_by_arm$txt_pm_tele) |>
    add_box(txt = counts_by_arm$txt_6weeks_postpartum) %>% 
    add_box(txt = counts_by_arm$txt_14weeks_postpartum) %>% 
    add_box(txt = counts_by_arm$txt_6months_postpartum)


consort_per
                
```

\newpage

# 4. Ineligibility

Women were ineligible if their gestational age at eligibility assessment was <20 weeks, if they endorsed thoughts/actions of self-harm, and if they endorsed symptoms of potential psychosis (e.g., hearing voices that others cannot hear, holding unusual beliefs, or feeling watched/followed), or if they endorsed experiencing memory problems.


```{r subcohort_prog, echo=FALSE, message=FALSE, warning=FALSE}
# source("Consort.R")
arm_ineligibility_summary <- consort_data %>% 
    filter(!is.na(exclusion)) %>% 
    tbl_summary(by = arm,
        sort = list(all_categorical() ~ "frequency"),  # Sort categorical levels by frequency in descending order
        include = c(exclusion),
        label = list(exclusion ~ "Reasons for Ineligibility")) %>% 
    bold_labels() %>%
    #add_p() %>% 
    add_overall() %>% 
    # convert from gtsummary object to gt object
    as_gt() %>%
    # modify with gt functions
    gt::tab_header("Summary of Study Ineligibility by Arm") %>% 
    gt::tab_options(
        table.font.size = "medium",
        data_row.padding = gt::px(1)) %>%
    tab_options(
        table.font.size = px(14))

arm_ineligibility_summary
```

\newpage

# 5. Baseline Demographics

## 5.1 Participant Baseline Demographics
Demographic characteristics were balanced across study arms, supporting baseline comparability.

```{r demographics, warning=F}

source("PPW RCT Basic Demographics.R")

arm_demo
```

\newpage
## 5.2 WLWH Cohort Baseline Demographics

Demographic characteristics were balanced across study arms, supporting baseline comparability.

```{r WLWH_demo, echo=FALSE}
# source("PPW RCT Basic Demographics.R")
arm_wlwh_demo

```

\newpage

# 6. Study Terminations
```{r Ealiest Expected termination}
first_6ths <- ppw_rct_df %>%
    # Filter to "6 months" and grab the first per participant
  filter(clt_visit == "6 months post-partum") %>%
    mutate(
    clt_timestamp = as_date(clt_date, format = "%Y-%m-%d")) %>% 
  group_by(clt_ptid) %>%
  slice_min(clt_date, n = 1) %>%    # in case there are duplicates
  ungroup() %>% 
    select(clt_study_site,clt_ptid, clt_date)

# First six-month visit date across participants
earliest_due <- first_6ths %>%
  slice_min(clt_date, n = 1) %>%
  select(clt_ptid, clt_date) %>% 
    pull(clt_date) 

total_exits <- ppw_rct_df%>%
    # Filter to "6 weeks" and grab the first per participant
  filter(clt_visit == "6 months post-partum") %>% 
    mutate(
    dummy_arm = case_when(
      grepl("Control", redcap_event_name) ~ "Arm X",
      TRUE ~ "Arm Y"
    )
  )

completed_follow_up <- total_exits %>% 
    filter(clt_visit=="6 months post-partum") %>% 
    nrow()

completed_follow_upX <- total_exits %>% 
    filter(dummy_arm == "Arm X") %>% 
    select(clt_ptid, clt_visit) %>% 
    filter(clt_visit=="6 months post-partum") %>% 
    nrow()
    
completed_follow_upY <- total_exits %>% 
    filter(dummy_arm == "Arm Y") %>% 
    select(clt_ptid, clt_visit) %>% 
    filter(clt_visit=="6 months post-partum") %>% 
    nrow()

```

To date, we have not recorded any early terminations. However, `r completed_follow_up` participants have exited the study as scheduled at the end of follow-up. The first termination occurred on `r earliest_due`. Of which, `r completed_follow_upX` and `r completed_follow_upY` were from the control and intervention arm, respectively. 


\newpage
# 7. Referrals

## 7.1 Psychosocial Referrals

```{r message=FALSE, warning=FALSE, include=FALSE}
source("PPW RCT Referrals.R")

total_visits <- referral_df %>%nrow()
total_scr_num <- df_long %>% nrow()
total_scr_per <- round(total_scr_num/total_visits *100, 1)
total_ref_num <- df_long %>% filter(referral_accept == "Yes") %>% nrow()
total_ref_per <- round(total_ref_num/total_scr_num *100, 1)

```


During enrollment and follow-up visits participants are asked if they would like to be referred for psychosocial support if they screen positive for depression, anxiety and intimate partner violence (IPV). Out of `r total_visits` total study visits, `r total_scr_num` (`r total_scr_per`%) participants have screened positive for  referable conditions. Of which, `r total_ref_num` (`r total_ref_per`%) have accepted referrals.


```{r referrals, echo=FALSE, message=FALSE, warning=FALSE}
## generate report using data from psychosocial referrals form in REDCap  
# source("PPW RCT Referrals.R")

arm_referral_summary
```


## 7.2 Treatment Referrals
```{r treatment_referrals_numsource, echo=FALSE, message=FALSE, warning=FALSE}
source("Telepsychiatry Sessions.R")
# Summarise ANC attendees and extract the sum as a numeric value
Attendees <- daily_closeout_df %>%
    summarise(`anc attendees` = sum(rct_anc_number, na.rm = TRUE)) %>%
    pull(`anc attendees`)  # Extract the sum value as a number
```

During this study period, `r Attendees` women attended MCH in the study clinics and were screened for PMAD symptoms, of whom `r screened_pmad` (`r round(screened_pmad / Attendees *100,1)`%) screened positive for PMAD. Among these, `r PM_referrals`(`r round (PM_referrals / screened_pmad *100,1)`%) had moderate symptoms in either PHQ9 or GAD7 and were referred to PM+, and `r telep_referrals` (`r round (telep_referrals / screened_pmad * 100,1)`%) had severe symptoms and were referred to psychiatrist.


```{r treatment_referrals, echo=FALSE, message=FALSE, warning=FALSE}
# source("Telepsychiatry Sessions.R")
#Generate a table/figure depicting stepped care intervention steps ???Screening,  PM+,  telepsychiatry tracking (kind of ???fidelity??? to intervention model) 
fidelity_summary

```

# 8 Study endpoints  

## 8.1 Primary and secondary study endpoints at 14 weeks postpartum (descriptive analysis)
```{r Outcome summary source, echo=FALSE, message=FALSE, warning=FALSE}
source("PPW RCT follow up.R")
arm_outcome_summary
```


\newpage
# 9. Adverse Events
## 9.1. Serious Adverse Events Summary

```{r Summary of SAEs}
source("SAEs Lists.R")
sae_summary

```

## 9.2 Adverse Events Summary

```{r ae_summary_morcohort, echo=FALSE}
source("SAEs Lists.R")
overal_aes
```


### 9.2.1 List of AEs: Control Arm

```{r ArmX_AEs, echo=FALSE, fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
# source("SAEs Lists.R")
armx_aes_gt
```

### 9.2.2 List of AEs: Intervention Arm

```{r ArmY_AEs, echo=FALSE, fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
# source("SAEs Lists.R")
army_aes_gt
```











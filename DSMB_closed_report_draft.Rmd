---
title: "IPMH: Community-based digital communication to support neonatal health"

subtitle: 'Data and Safety Monitoring Board (DSMB): Closed Report '
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, options(scipen = 0))

library(stringr)
library(lubridate)
library(patchwork)
library(officedown)
library(officer)
library(flextable)

## WORKING DIRECTORY
# Setup ------------------------------------------------------------------------

###########################################################################################

#### Note to analyst: change "analysis" to "Not Test"  in the faketreatment_helper.R script to run with actual treatment group data

###########################################################################################

# Set latex options (+latex troubleshooting)
# options(tinytex.verbose = TRUE)
# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::reinstall_tinytex()

rm(list = ls())             

# Reference source codes & other dependencies:
source("DataTeam_ipmh.R")
source("Dependencies.R")

# Set file paths: Use this section to set input and output filepaths
file_date <- fileSnapshot(file.path(ipmh_filepath, "/Data/6. RCT PPW data/"))
file_date <- rownames(file_date$info[which.max(file_date$info$mtime),])
file_date <- gsub("^.*?_2","2",file_date)
file_date <- str_remove(file_date,".csv")
file_date <- format(file_date, format="%d %B %Y")
ppw_rct_df <- read.csv(paste0(ipmh_filepath, "/Data/6. RCT PPW data/RCT_PPW_", 
                              file_date, ".csv", sep="")) %>% 
    filter(is.na(redcap_repeat_instance)) #PPW data

daily_closeout_df <- read.csv(paste0(ipmh_filepath, "/Data/7. RCT admin data/Daily_closeout_", 
                                     file_date, ".csv", sep=""))

screening_consent_df <- read.csv(paste0(ipmh_filepath, 
                                        "/Data/2. Consenting database/RCT_PPW_consenting_", 
                                        file_date, ".csv", sep=""))

pm_survey_df <- read.csv(paste0(ipmh_filepath, "/Data/7. RCT admin data/PM_", 
                                file_date, ".csv", sep="" ))

ppw_sae_df <- read.csv(paste0(ipmh_filepath, "/Data/6. RCT PPW data/RCT_PPW_", 
                                             file_date, ".csv", sep="")) %>% 
    filter(redcap_repeat_instrument == "ADMIN: Adverse Experience")

data_freeze <- file_date

data_freeze <- format(data_freeze, format="%d %B %Y")
options(scipen = 0)
```


```{r logo,  out.width = "100%", echo=FALSE, eval = T, fig.height=4, fig.width=4}

knitr::include_graphics(paste0(file.path(ipmh_filepath, "/Data/IPMH logo.jpg")))

```


```{r logo,  out.width = "100%", echo=FALSE, eval = T, fig.height=4, fig.width=4}

knitr::include_graphics(paste0(file.path(ipmh_filepath, "/Data/IPMH logo.jpg")))
```

\newpage

ohn Kinuthia, MBChD, MMed, MPH, Kenyatta National Hospital

Keshet Ronen, PhD, MPH, University of Washington

Amritha Bhat, MBBS, MD, MPH, University of Washington

Report prepared by: David Owaga & Yuwei Wang

Date of data freeze: `r data_freeze`
\newpage

\tableofcontents

\newpage


# 1. Study summary

```{r study_summary}
vars <- c("Primary Objective", "Study Design", "Study Population", "Inclusion Criteria",
          "Target Sample Size",
          "Actual Enrollment",
          "Participants Completed Follow-up", "Duration", 
          "Date Study Open", "Date of First Complete Enrollment",
          "Estimated End of Study",
          "Endpoints", "")

vars2 <- c("Integrate IPMH, a stepped care intervention for screening and treatment of perinatal mood and anxiety disorders (PMADs), and its implementation strategies, into maternal and child health clinics and pragmatically evaluate its clinical, service delivery, and implementation outcomes",
           "A 2-arm, non-blinded cluster randomized controlled trial (RCT) comparing the effect of IPMH and associated implementation strategies on depression, anxiety, quality of life, and adverse perinatal outcomes vs. control (standard of care) among Kenyan women", 
           "Pregnant Kenyan women", 
           "-Receiving antenatal care at study facility\n->=28 weeks gestation\n-Age>=14\n-screen positive for PMAD symptoms (PHQ-2>=3 and/or GAD-2>=3)", 
           "2970, including 405 women living with HIV (WLWH)", 
           "[place holder]",
           "0",
           "Follow-up through 6 months postpartum", 
           "September 19, 2023", 
           "February 17, 2025",
           "July 31, 2028",
           "Primary: Depression and anxiety", 
           "Secondary:\n-Depression and anxiety among WLWH\n-Quality of Life\n-Adverse perinatal outcomes")

stdy_summ <- data.frame(vars, vars2)

study_summary <- flextable(stdy_summ)
study_summary <- flextable::width(study_summary, 'vars2', width = 5)
study_summary <- flextable::width(study_summary, 'vars', width = 2)
border <- fp_border()
study_summary <- flextable::vline(study_summary, j = c('vars'), border = border, part = "all")
study_summary <- set_header_labels(study_summary, vars = "Title", vars2 = "IPMH: Integration of stepped care for perinatal mood and anxiety disorders among women attending MCH clinics")

study_summary
```

\newpage

# 2. Study Enrollment

```{r Consort, warning=FALSE, message=FALSE}
source("Consort.R")
consort_per

```
ANC visits are program data without patient identifiers and not de-duplicated.



## 2.2 Mortality cohort 

### 2.2.1  Enrollment Progress - Overall


```{r enrollment_prohress, echo=FALSE}
source("Enrollment Progress.R")
#shorten the names of the study sites
weekly_enrollment <- weekly_enrollment %>%
  mutate(study_site = recode(study_site,
    "01, Rwambwa Sub-county Hospital" = "01, Rwambwa",
    "02, Sigomere Sub County Hospital" = "02, Sigomere",
    "03, Uyawi Sub County Hospital" = "03, Uyawi",
    "04, Got Agulu Sub-District Hospital" = "04, Got Agulu",
    "05, Ukwala Sub County Hospital" = "05, Ukwala",
    "06, Madiany Sub County Hospital" = "06, Madiany",
    "07, Kabondo Sub County Hospital" = "07, Kabondo",
    "08, Mbita Sub-County Hospital" = "08, Mbita",
    "09, Miriu Health Centre" = "09, Miriu",
    "11, Nyandiwa Level IV Hospital" = "11, Nyandiwa",
    "13, Ober Kamoth Sub County Hospital" = "13, Ober Kamoth",
    "14, Gita Sub County Hospital" = "14, Gita",
    "15, Akala Health Centre" = "15, Akala",
    "16, Usigu Health Centre" = "16, Usigu",
    "17, Ramula Health Centre" = "17, Ramula",
    "18, Simenya Health Centre" = "18, Simenya",
    "19, Airport Health Centre (Kisumu)" = "19, Airport",
    "20, Nyalenda Health Centre" = "20, Nyalenda",
    "21, Mirogi Health Centre" = "21, Mirogi",
    "22, Ndiru Level 4 Hospital" = "22, Ndiru"
  )) 

# Create target line repeated for each arm_group
arm_groups <- unique(weekly_enrollment %>%
                       mutate(arm = stringr::str_extract(study_site, "^\\d{2}"),
                              arm_group = ifelse(arm %in% c("01", "02", "03", "04", "05", "06", "07"),
                                                 "Control", "Intervention")) %>%
                       pull(arm_group) %>%
                       unique())

target_25_line <- expand.grid(
  week = unique(weekly_enrollment$week),
  arm_group = arm_groups
) %>%
  mutate(
    cumulative_enrollment = 372,
    study_site = "25% Target"
  )

weekly_enrollment <- weekly_enrollment %>%
  mutate(
    arm = stringr::str_extract(study_site, "^\\d{2}"),
    arm_group = ifelse(arm %in% c("01", "02", "03", "04", "05", "06", "07"),
                       "Control", "Intervention")
  )

total_enrollment <- weekly_enrollment %>%
  group_by(week, arm_group) %>%
  summarise(enrollment_count = sum(enrollment_count), .groups = "drop") %>%
  arrange(week) %>%
  group_by(arm_group) %>%
  mutate(cumulative_enrollment = cumsum(enrollment_count)) %>%
  mutate(study_site = "Total")

combined_enrollment <- bind_rows(
  weekly_enrollment,
  total_enrollment,
  target_25_line
)

p1 <- ggplot(combined_enrollment, aes(x = week, y = cumulative_enrollment, 
                                      color = study_site, group = study_site)) +
  geom_line(aes(linewidth = ifelse(study_site == "Total", 1.5, 0.5))) +
  scale_linewidth_identity() +
  facet_wrap(~ arm_group, scales = "free_y") +  # one panel per arm
  labs(
    title = "Enrollment Trends by Study Arm",
    x = "Date",
    y = "Cumulative Enrollment",
    color = "Study Site"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    strip.text = element_text(size = 10, face = "bold")
  ) +
  guides(color = guide_legend(ncol = 2))

p1

```


\newpage

### 3.1.3 Enrollment Progress - Per Facility
```{r Facility target reached}
source("Enrollment Progress.R")
reached_25per_target <- weekly_enrollment %>%
  group_by(study_site) %>%
  summarise(latest_enrollment = max(cumulative_enrollment, na.rm = TRUE)) %>%
  filter(latest_enrollment >= 37) %>%
  summarise(n = n()) %>%
  pull(n)

```

`r reached_25per_target` facilities have reached the 25% enrollment target of 37 perinatal women per facility cluster. The first cluster to achieve this milestone was Nyalenda in mid-April 2024.

```{r enrollment_sub_facility}
source("Enrollment Progress.R")

#shorten the names of the study sites
weekly_enrollment <- weekly_enrollment %>%
  mutate(study_site = recode(study_site,
    "01, Rwambwa Sub-county Hospital" = "01, Rwambwa",
    "02, Sigomere Sub County Hospital" = "02, Sigomere",
    "03, Uyawi Sub County Hospital" = "03, Uyawi",
    "04, Got Agulu Sub-District Hospital" = "04, Got Agulu",
    "05, Ukwala Sub County Hospital" = "05, Ukwala",
    "06, Madiany Sub County Hospital" = "06, Madiany",
    "07, Kabondo Sub County Hospital" = "07, Kabondo",
    "08, Mbita Sub-County Hospital" = "08, Mbita",
    "09, Miriu Health Centre" = "09, Miriu",
    "11, Nyandiwa Level IV Hospital" = "11, Nyandiwa",
    "13, Ober Kamoth Sub County Hospital" = "13, Ober Kamoth",
    "14, Gita Sub County Hospital" = "14, Gita",
    "15, Akala Health Centre" = "15, Akala",
    "16, Usigu Health Centre" = "16, Usigu",
    "17, Ramula Health Centre" = "17, Ramula",
    "18, Simenya Health Centre" = "18, Simenya",
    "19, Airport Health Centre (Kisumu)" = "19, Airport",
    "20, Nyalenda Health Centre" = "20, Nyalenda",
    "21, Mirogi Health Centre" = "21, Mirogi",
    "22, Ndiru Level 4 Hospital" = "22, Ndiru"
  )) %>%
  mutate(
    arm = stringr::str_extract(study_site, "^\\d{2}"),
    arm_group = ifelse(arm %in% c("02", "05", "06", "08", "11", "15", "18", "20", "21"),
                       "Control", "Intervention")
  )

p2 <- ggplot(weekly_enrollment, aes(x = week, y = cumulative_enrollment, 
                                    color = study_site, group = study_site)) +
  geom_line(linewidth = 1) +  
  geom_hline(yintercept = 37, linetype = "dashed", color = "blue", linewidth = 1.5) +
  annotate("text", x = min(weekly_enrollment$week), y = 37.125, 
           label = "25% Target", vjust = -1, hjust = 0, size = 3) +
  labs(title = "Enrollment Trends by Study Arm",
       x = "Date",
       y = "Cumulative Enrollment",
       color = "Study Site") +
  facet_wrap(~ arm_group) +  # ??? facet by arm_group
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    strip.text = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)  # Center and bold title
  ) +
  guides(color = guide_legend(ncol = 2))


p2
```

\newpage

## 3.2 WLWH Cohort

### 3.2.1 Current subject status


```{r consortnumsource, echo=FALSE, fig.height=4, fig.width=8, message=FALSE, warning=FALSE}
source("Consort_WLWH.R")
```

From `r n_enrolled` participants, `r n_hiv` (`r round(n_hiv/n_enrolled*100, 1)`%) women were HIV positive, meeting `r round(n_hiv/405*100, 1)`% of our WLWH cohort enrollment target. Of these, `r n_postpartum` (`r round(n_postpartum/n_hiv *100,1 )`%) have completed their 6 week postpartum follow-up with our study team.


```{r consort_mortality, warning = F}
source("Consort_WLWH.R")

add_box(txt = txt_enrolled) |>
    add_box(txt = txt_hiv) |>
    add_side_box(txt = txt_pm_tele) |>
    add_box(txt = txt_postpartum)
```

\newpage

## 3.2 Mortality Cohort Baseline Demographics

Participant characteristics are generally (similar/different) across arms. We do, however, see a (statistically significant/non statistically significant) difference in (XXXX).



```{r morcohort_demo, echo=FALSE}
source("mort_demo.R")

kable(mort_demo_closed) %>%
kable_styling(latex_options = c("striped", "HOLD_position", position = "center")) %>%
  row_spec(0,bold=T) %>%
  row_spec(1,bold=T)

```


# 4. CHP Workflow Process Outcomes
CHPs perform their duties based on "tasks" in eCHIS. ANC tasks are periodically assigned to CHPs for completion based on the gestational age of a mother. PNC tasks are periodically assigned to CHPs based on the age of a newborn. SMS scheduling and some mortality cohort outcomes are based on data collected by CHPs in ANC and PNC tasks. Therefore, completion of ANC and PNC tasks may align with the fidelity of intervention implementation and overall data collection for study outcomes. The table below summarizes task completion data for all tasks past their date scheduled for completion.



```{r chp_workflows, echo=FALSE}
source("chpworkflow_completion_tbls.R")

kable_styling(task_completion_tbl) %>%
  kable_styling(latex_options = "HOLD_position") %>% 
  row_spec(0,bold=T) %>% 
  add_indent(c(2,4)) %>% 
  row_spec(2,hline_after=T)

```

\newpage

# 5. Time from Delivery to eCHIS Delivery Report
Timely ascertainment of delivery enables timely scheduling of postpartum visits by CHPs and, in the intervention arm, initiation of time-sensitive postpartum messaging. The tables below summarize the time from delivery date to delivery report submission in eCHIS. 


## 5.1 Sub Cohort


```{r deliveryreport_tat_sub, echo=FALSE}
source("deliveryreportTAT.R")
kable_styling(sub_deliverytat_summary_closed) %>%
  kable_styling(latex_options = "HOLD_position") %>% 
  row_spec(0,bold=T)
```



## 5.2 Mortality Cohort 



```{r deliveryreport_tat_mort, echo=FALSE}
source("deliveryreportTAT.R")
kable_styling(deliverytat_summary_closed) %>%
  kable_styling(latex_options = "HOLD_position") %>% 
  row_spec(0,bold=T)
```


\newpage

# 6. Two Way SMS
We have been monitoring CHPs’ responsiveness to client SMS as an indicator of intervention fidelity. To optimize intervention delivery, we are using audit and feedback to share this data with CHPs and their supervisors on a monthly basis and identify ways to improve intervention delivery.


```{r twoway_sms_load, warning=FALSE, echo=FALSE, results='hide'}
source("chpmonthlymtg_data.R")
```

```{r twoway_sms, warning=FALSE, echo=FALSE}
kable_styling(all_twoway_sms_tbl) %>%
  kable_styling(latex_options = c("HOLD_position", position = "center")) %>% 
  row_spec(0,bold=T) %>%
  row_spec(1,bold=T) %>%
  row_spec(4,bold=T) %>%
  row_spec(5,bold=T) %>%
  row_spec(6,bold=T)

```


## 6.1 Monthly Two Way SMS
We began these monthly reviews in May 2024, and are beginning to see performance improvements.


```{r monthly_twoway_sms,echo=FALSE}

kable_styling(monthly_twoway_sms_tbl) %>%
  kable_styling(latex_options = c("HOLD_position", position = "center")) %>% 
  row_spec(0,bold=T)

```


\newpage
```{r ae_summary_desc, echo=FALSE}
source("ae_dsmb_tbls.R")
```


# 7. Adverse Events


## 7.1 Mortality cohort 
The final mortality cohort will consist of only those who experienced live births at the end of their pregnancies. In order to report pregnancy losses, the adverse event data shown below is for all pregnancies in eCHIS.


```{r ae_summary_morcohort, echo=FALSE}
source("ae_mort_dsmb_tbls.R")

kable_styling(ae_mortcohort_summary) %>%
  kable_styling(latex_options = c("scale_down", "HOLD_position", position = "center")) %>% 
  row_spec(0,bold=T) %>% 
  row_spec(1,bold=T) %>% 
  row_spec(4,bold=T) 
```


```{r ae_summary_subcohortdesc, echo=FALSE}
source("ae_dsmb_tbls.R")

```


## 7.2 Sub cohort 
A total of `r overall_ae_num` adverse events have occurred among 2000 study participants.The most common adverse event was infant death, which occurred among `r overall_infdeath_per` of total study participants.The table below lists characteristics of adverse events. None have been determined to have been related to study procedures.



```{r ae_summary_subcohort, echo=FALSE}
source("ae_dsmb_tbls.R")
kable_styling(ae_subcohort_summary) %>%
  kable_styling(latex_options = "HOLD_position") %>% 
  row_spec(0,bold=T) %>% 
  row_spec(1,bold=T) %>% 
  row_spec(2,bold=T) %>% 
  row_spec(5,bold=T)


```
\newpage


### 7.2.1 List of SAEs: Arm X 



```{r saes_intervention, echo=FALSE, message = FALSE}
source("ae_linelists.R")
kable_styling(int_ae_linelist2) %>% 
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position", position = "center","repeat_header")) %>% 
   row_spec(0,bold=T)

```

\newpage
### 7.2.2 List of SAEs: Arm Y 


```{r saes_control, echo=FALSE, message = FALSE}
source("ae_linelists.R")

kable_styling(con_ae_linelist2)  %>% 
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position", position = "center","repeat_header")) %>% 
   row_spec(0,bold=T)
```











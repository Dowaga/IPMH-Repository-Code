---
title: "IPMH: Integration of stepped care for perinatal mood and anxiety disorders among women attending MCH clinics"

subtitle: 'Data and Safety Monitoring Board (DSMB): Closed Report '
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document
    #pdf_document:
    #latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, options(scipen = 0))

rm(list = ls())             

# Reference source codes & other dependencies:
source("DataTeam_ipmh.R")
source("Dependencies.R")

## WORKING DIRECTORY
# Setup ------------------------------------------------------------------------

###########################################################################################

#### Note to analyst: change "analysis" to "Not Test"  in the faketreatment_helper.R script to run with actual treatment group data

###########################################################################################

# Set latex options (+latex troubleshooting)
# options(tinytex.verbose = TRUE)
# update.packages(ask = FALSE, checkBuilt = TRUE)
# tinytex::tlmgr_update()
# tinytex::reinstall_tinytex()

# Set file paths: Use this section to set input and output filepaths
file_date <- fileSnapshot(file.path(ipmh_filepath, "/Data/6. RCT PPW data/"))
file_date <- rownames(file_date$info[which.max(file_date$info$mtime),])
file_date <- gsub("^.*?_2","2",file_date)
file_date <- str_remove(file_date,".csv")
file_date <- format(file_date, format="%d %B %Y")
ppw_rct_df <- read.csv(paste0(ipmh_filepath, "/Data/6. RCT PPW data/RCT_PPW_", 
                              file_date, ".csv", sep="")) %>% 
    filter(is.na(redcap_repeat_instance)) #PPW data

daily_closeout_df <- read.csv(paste0(ipmh_filepath, "/Data/7. RCT admin data/Daily_closeout_", 
                                     file_date, ".csv", sep=""))

screening_consent_df <- read.csv(paste0(ipmh_filepath, 
                                        "/Data/2. Consenting database/RCT_PPW_consenting_", 
                                        file_date, ".csv", sep=""))

pm_survey_df <- read.csv(paste0(ipmh_filepath, "/Data/7. RCT admin data/PM_", 
                                file_date, ".csv", sep="" ))

ppw_sae_df <- read.csv(paste0(ipmh_filepath, "/Data/6. RCT PPW data/RCT_PPW_", 
                                             file_date, ".csv", sep="")) %>% 
    filter(redcap_repeat_instrument == "ADMIN: Adverse Experience")

data_freeze <- file_date

data_freeze <- format(data_freeze, format="%d %B %Y")
options(scipen = 0)
```


```{r logo,  out.width = "100%", echo=FALSE, eval = T, fig.height=4, fig.width=4}

knitr::include_graphics(paste0(file.path(ipmh_filepath, "/Data/IPMH logo.jpg")))

```


\newpage

ohn Kinuthia, MBChD, MMed, MPH, Kenyatta National Hospital

Keshet Ronen, PhD, MPH, University of Washington

Amritha Bhat, MBBS, MD, MPH, University of Washington

Report prepared by: David Owaga

Date of data freeze: `r data_freeze`

\newpage

# 1. Study summary

```{r study_summary}
vars <- c("Primary Objective", "Study Design", "Study Population", "Inclusion Criteria",
          "Target Sample Size",
          "Actual Enrollment",
          "Participants Completed Follow-up", "Duration", 
          "Date Study Open", "Date of First Complete Enrollment",
          "Estimated End of Study",
          "Endpoints", "")

vars2 <- c("Integrate IPMH, a stepped care intervention for screening and treatment of perinatal mood and anxiety disorders (PMADs), and its implementation strategies, into maternal and child health clinics and pragmatically evaluate its clinical, service delivery, and implementation outcomes",
           "A 2-arm, non-blinded cluster randomized controlled trial (RCT) comparing the effect of IPMH and associated implementation strategies on depression, anxiety, quality of life, and adverse perinatal outcomes vs. control (standard of care) among Kenyan women", 
           "Pregnant Kenyan women", 
           "-Receiving antenatal care at study facility\n->=28 weeks gestation (changed to >=20 weeks gestation\n-Age>=14\n-screen positive for PMAD symptoms (PHQ-2>=3 and/or GAD-2>=3)", 
           "2970, including 405 women living with HIV (WLWH)", 
           "[place holder]",
           "0",
           "Follow-up through 6 months postpartum", 
           "September 19, 2023", 
           "February 17, 2025",
           "July 31, 2028",
           "Primary: Depression and anxiety", 
           "Secondary:\n-Depression and anxiety among WLWH\n-Quality of Life\n-Adverse perinatal outcomes")

stdy_summ <- data.frame(vars, vars2)

study_summary <- flextable(stdy_summ)
study_summary <- flextable::width(study_summary, 'vars2', width = 5)
study_summary <- flextable::width(study_summary, 'vars', width = 2)
border <- fp_border()
study_summary <- flextable::vline(study_summary, j = c('vars'), border = border, part = "all")
study_summary <- set_header_labels(study_summary, vars = "Title", vars2 = "IPMH: Integration of stepped care for perinatal mood and anxiety disorders among women attending MCH clinics")

study_summary
```

\newpage
# 2. Study Enrollment

```{r Consort,echo=FALSE, fig.height=12, fig.width=16, message=FALSE, warning=FALSE}
source("Consort.R")
counts_by_arm <- consort_data %>%
    filter(!is.na(arm)) %>%
    group_by(dummy_arm) %>%
    summarise(
        assessed = n(),
        excluded = sum(!is.na(exclusion)),
        eligible = sum(eligible == 1, na.rm = TRUE),
        enrolled = sum(rct_enrolling == "Yes", na.rm = TRUE),
        pm_participants = sum(ipmh_participant == "Yes", na.rm = TRUE),
        tele_participants = sum(tele == "Yes", na.rm = TRUE),
        postpartum_visit = sum(secondvisit == "Yes", na.rm = TRUE),
        postpartum_visit1 = sum(thirdvisit == "Yes", na.rm = TRUE),
        postpartum_visit2 = sum(fourthvisit == "Yes", na.rm = TRUE)
    )

# Function to generate stage text
generate_stage_text <- function(stage_label, numerator, denominator, decimals = 2) {
    percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
    sprintf("%s\n (n=%d, %.*f%%)", stage_label, numerator, decimals, percent)
}

# Apply to each arm
counts_by_arm <- counts_by_arm %>%
    rowwise() %>%
    mutate(
        txt_eligible = generate_stage_text("Eligible", eligible, assessed),
        txt_excluded = generate_stage_text("Excluded", excluded, assessed),
        txt_enrolled = generate_stage_text("Enrolled", enrolled, eligible),
        txt_pm = generate_stage_text("PM+", pm_participants, enrolled),
        txt_tele = generate_stage_text("Telepsychiatry", tele_participants, enrolled),
        txt_postpartum = generate_stage_text("6 weeks postpartum visit", postpartum_visit, enrolled),
        txt_postpartum1 = generate_stage_text("14 weeks postpartum visit", postpartum_visit1, enrolled),
        txt_postpartum2 = generate_stage_text("6 months postpartum visit", postpartum_visit2, enrolled)
    )

# Total text for ANC attendees
txt_anc <- sprintf("ANC Attendees (n=%d)", n_attendees)

# Total assessment
txt_ass <- sprintf("Assessed for Eligibility\n (n=%d, %.1f%%)", n_assessed, (n_assessed / n_attendees) * 100)

txt_arm <- counts_by_arm %>%
    mutate(
        txt = sprintf("%s\n (n=%d, %.1f%%)", dummy_arm, assessed, (assessed / n_assessed) * 100)
    ) %>%
    pull(txt)

#combine PM+ and telepsychiatry
counts_by_arm <- counts_by_arm %>%
    mutate(
        txt_pm_tele = paste(txt_pm, txt_tele, sep = "\n"))

generate_box_header <- function(label, numerator, denominator, decimals = 2) {
percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
sprintf("%s (n=%d, %.*f%%):", label, numerator, decimals, percent)
}

# Build exclusion string per arm
exclusion_side_boxes <- consort_data %>%
    filter(!is.na(exclusion)) %>%
    group_by(dummy_arm, exclusion_reason = exclusion) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>% select(dummy_arm, excluded, assessed),
        by = "dummy_arm"
    ) %>%
    group_split(dummy_arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$dummy_arm)
        excluded <- unique(df_arm$excluded)
        assessed <- unique(df_arm$assessed)
        
        # Header line (no real line break)
        header <- generate_box_header("Excluded", excluded, assessed)
        
        # Bullet lines (keep \\n as character)
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / excluded) * 100)
            },
            df_arm$exclusion_reason,
            df_arm$count
        )
        
        # Combine header + bullets with literal \n characters
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_ex <- unlist(exclusion_side_boxes)

# Build decline side boxes per arm
decline_side_boxes <- consort_data %>%
    filter(!is.na(rct_decline_reason)) %>%
    group_by(dummy_arm, decline_reason = rct_decline_reason) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>%
            mutate(declined = eligible - enrolled) %>%
            select(dummy_arm, declined, eligible),
        by = "dummy_arm"
    ) %>%
    group_split(dummy_arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$dummy_arm)
        declined <- unique(df_arm$declined)
        eligible <- unique(df_arm$eligible)
        
        # Header line (with real line break later)
        header <- sprintf("Declined Enrollment (n=%d, %.1f%%):", declined, (declined / eligible) * 100)
        
        # Bullet lines with Unicode bullets and percentages
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / declined) * 100)
            },
            df_arm$decline_reason,
            df_arm$count
        )
        
        # Combine header + bullets with **real line breaks**
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_decline <- unlist(decline_side_boxes)

# 14d834c07edb977b556fed4c00a6c156b7d65458

consort_per <- add_box(txt = txt_anc) |>
    add_box(txt = txt_ass) |>
    add_split(txt = txt_arm) |>
    add_side_box(txt = txt_ex) |>
    add_box(txt = counts_by_arm$txt_eligible) |>
    add_side_box(txt = txt_decline) |>
    add_box(txt = counts_by_arm$txt_enrolled) |>
    add_side_box(txt= counts_by_arm$txt_pm_tele) |>
    add_box(txt = counts_by_arm$txt_postpartum)|>
    add_box(txt = counts_by_arm$txt_postpartum1)|>
    add_box(txt = counts_by_arm$txt_postpartum2)

consort_per
```

\newpage
## 2.2  Enrollment Progress

## 2.2.1  Enrollment Progress - Overall

```{r enrollment_progress, fig.width=9, fig.height=6, echo=FALSE}
source("Enrollment Progress.R")
#shorten the names of the study sites
weekly_enrollment <- weekly_enrollment %>%
  mutate(study_site = recode(study_site,
    "01, Rwambwa Sub-county Hospital" = "01, Rwambwa",
    "02, Sigomere Sub County Hospital" = "02, Sigomere",
    "03, Uyawi Sub County Hospital" = "03, Uyawi",
    "04, Got Agulu Sub-District Hospital" = "04, Got Agulu",
    "05, Ukwala Sub County Hospital" = "05, Ukwala",
    "06, Madiany Sub County Hospital" = "06, Madiany",
    "07, Kabondo Sub County Hospital" = "07, Kabondo",
    "08, Mbita Sub-County Hospital" = "08, Mbita",
    "09, Miriu Health Centre" = "09, Miriu",
    "11, Nyandiwa Level IV Hospital" = "11, Nyandiwa",
    "13, Ober Kamoth Sub County Hospital" = "13, Ober Kamoth",
    "14, Gita Sub County Hospital" = "14, Gita",
    "15, Akala Health Centre" = "15, Akala",
    "16, Usigu Health Centre" = "16, Usigu",
    "17, Ramula Health Centre" = "17, Ramula",
    "18, Simenya Health Centre" = "18, Simenya",
    "19, Airport Health Centre (Kisumu)" = "19, Airport",
    "20, Nyalenda Health Centre" = "20, Nyalenda",
    "21, Mirogi Health Centre" = "21, Mirogi",
    "22, Ndiru Level 4 Hospital" = "22, Ndiru"
  )) 

# Create target line repeated for each arm_group
arm_groups <- unique(weekly_enrollment %>%
                       mutate(arm = stringr::str_extract(study_site,"^\\d{2}"),
                              arm_group = ifelse(arm %in% c("02","05", "06", "08", "11", "14", "15", "18", "20", "22"),
                                                 "Control", "Intervention")) %>%
                       pull(arm_group) %>%
                       unique())

target_25_line <- expand.grid(
  week = unique(weekly_enrollment$week),
  arm_group = arm_groups
) %>%
  mutate(
    cumulative_enrollment = 372,
    study_site = "25% Target"
  )

weekly_enrollment <- weekly_enrollment %>%
  mutate(
    arm = stringr::str_extract(study_site, "^\\d{2}"),
    arm_group = ifelse(arm %in% c("01", "02", "03", "04", "05", "06", "07"),
                       "Control", "Intervention")
  )

total_enrollment <- weekly_enrollment %>%
  group_by(week, arm_group) %>%
  summarise(enrollment_count = sum(enrollment_count), .groups = "drop") %>%
  arrange(week) %>%
  group_by(arm_group) %>%
  mutate(cumulative_enrollment = cumsum(enrollment_count)) %>%
  mutate(study_site = "Total")

combined_enrollment <- bind_rows(
  weekly_enrollment,
  total_enrollment,
  target_25_line
) %>% 
    mutate(
  dummy_arm = case_when(
        arm_group == "Control" ~ "Arm X",
        arm_group == "Intervention" ~ "Arm Y"))

p1 <- ggplot(combined_enrollment, aes(x = week, y = cumulative_enrollment, 
                                      color = study_site, group = study_site)) +
  geom_line(aes(linewidth = ifelse(study_site == "Total", 1.5, 0.5))) +
  scale_linewidth_identity() +
  facet_wrap(~ dummy_arm, ncol = 1) +  # one panel per arm
  labs(
    title = "Enrollment Trends by Study Arm",
    x = "Date",
    y = "Cumulative Enrollment",
    color = "Study Site"
  ) +
  theme_minimal() +
  theme(
    legend.position = "left",
    legend.box = "vertical",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    strip.text = element_text(size = 10, face = "bold")
  ) +
  guides(color = guide_legend(ncol = 2))

p1

```


\newpage

### 2.2.2 Enrollment Progress - Per Facility
```{r Facility target reached}
source("Enrollment Progress.R")
reached_25per_target <- weekly_enrollment %>%
  group_by(study_site) %>%
  summarise(latest_enrollment = max(cumulative_enrollment, na.rm = TRUE)) %>%
  filter(latest_enrollment >= 37) %>%
  summarise(n = n()) %>%
  pull(n)

```

All (`r reached_25per_target`) facilities have surpassed our first enrollment milestone, with more than 37 perinatal women enrolled per facility cluster - exceeding 25% of the overall target enrollment. Nyalenda was the first facility to achieve this milestone in mid-April 2024.

```{r enrollment_sub_facility, fig.width=9, fig.height=6, echo=FALSE}
source("Enrollment Progress.R")

#shorten the names of the study sites
weekly_enrollment <- weekly_enrollment %>%
  mutate(study_site = recode(study_site,
    "01, Rwambwa Sub-county Hospital" = "01, Rwambwa",
    "02, Sigomere Sub County Hospital" = "02, Sigomere",
    "03, Uyawi Sub County Hospital" = "03, Uyawi",
    "04, Got Agulu Sub-District Hospital" = "04, Got Agulu",
    "05, Ukwala Sub County Hospital" = "05, Ukwala",
    "06, Madiany Sub County Hospital" = "06, Madiany",
    "07, Kabondo Sub County Hospital" = "07, Kabondo",
    "08, Mbita Sub-County Hospital" = "08, Mbita",
    "09, Miriu Health Centre" = "09, Miriu",
    "11, Nyandiwa Level IV Hospital" = "11, Nyandiwa",
    "13, Ober Kamoth Sub County Hospital" = "13, Ober Kamoth",
    "14, Gita Sub County Hospital" = "14, Gita",
    "15, Akala Health Centre" = "15, Akala",
    "16, Usigu Health Centre" = "16, Usigu",
    "17, Ramula Health Centre" = "17, Ramula",
    "18, Simenya Health Centre" = "18, Simenya",
    "19, Airport Health Centre (Kisumu)" = "19, Airport",
    "20, Nyalenda Health Centre" = "20, Nyalenda",
    "21, Mirogi Health Centre" = "21, Mirogi",
    "22, Ndiru Level 4 Hospital" = "22, Ndiru"
  )) %>%
  mutate(
    arm = stringr::str_extract(study_site, "^\\d{2}"),
    arm_group = ifelse(arm %in% c("02", "05", "06", "08", "11", "15", "18", "20", "21"),
                       "Arm X", "Arm Y")
  )

p2 <- ggplot(weekly_enrollment, aes(x = week, y = cumulative_enrollment, 
                                    color = study_site, group = study_site)) +
  geom_line(linewidth = 1) +  
  geom_hline(yintercept = 37, linetype = "dashed", color = "blue", linewidth = 1.5) +
  annotate("text", x = min(weekly_enrollment$week), y = 37.125, 
           label = "25% Target", vjust = -1, hjust = 0, size = 3) +
  labs(title = "Enrollment Trends by Study Arm",
       x = "Date",
       y = "Cumulative Enrollment",
       color = "Study Site") +
  facet_wrap(~ arm_group, ncol = 1) +  # ??? facet by arm_group
  theme_minimal() +
  theme(
    legend.position = "left",
    legend.box = "vertical",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    strip.text = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)  # Center and bold title
  )


p2
```

\newpage

# 3. WLWH Cohort

## 3.1 Current subject status

```{r consortnumsource, echo=FALSE, fig.height=4, fig.width=8, message=FALSE, warning=FALSE}
source("Consort_WLWH.R")
```

Overall `r n_enrolled` participants have been enrolled into the study, of which `r n_hiv` women are living with HIV (WLHIV), accounting to `r round(n_hiv/n_enrolled*100, 1)`% of total enrollments. Of these, `r six_weeks` (`r round(six_weeks/n_hiv *100,1 )`%) have completed their 6 weeks, `r fourteen_weeks` (`r round(fourteen_weeks/n_hiv*100,1)`%) have completed 14 weeks, and `r six_months` (`r round(six_months/n_hiv*100,1)`%) have completed their 6 months postpartum follow-up visits. 

```{r consort_WLWHIV, echo=FALSE, fig.height=9, fig.width = 15, message = FALSE, warning = FALSE}
source("Consort_WLWH.R")

counts_by_arm <- consort_data %>%
    filter(!is.na(dummy_arm)) %>%
    group_by(dummy_arm) %>%
    summarise(
        assessed = n(),
        excluded = sum(!is.na(exclusion)),
        eligible = sum(eligible == 1, na.rm = TRUE),
        enrolled = sum(rct_enrolling == "Yes", na.rm = TRUE),
        hiv = sum(WLWH == "Yes", na.rm = TRUE),
        pm_participants = sum(ipmh_participant == "Yes" & WLWH == "Yes", na.rm = TRUE),
        tele_participants = sum(tele == "Yes" & WLWH == "Yes", na.rm = TRUE),
        six_weeks_visit = sum(secondvisit == "Yes" & WLWH == "Yes", na.rm = TRUE),
        fourteen_weeks_visit = sum(thirdvisit == "Yes" & WLWH == "Yes", na.rm = TRUE),
        six_months_visit = sum(fourthvisit == "Yes" & WLWH == "Yes", na.rm = TRUE)
    )

# Function to generate stage text
generate_stage_text <- function(stage_label, numerator, denominator, decimals = 2) {
    percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
    sprintf("%s\n (n=%d, %.*f%%)", stage_label, numerator, decimals, percent)
}

# Apply to each arm
counts_by_arm <- counts_by_arm %>%
    rowwise() %>%
    mutate(
        txt_eligible = generate_stage_text("Eligible", eligible, assessed),
        txt_excluded = generate_stage_text("Excluded", excluded, assessed),
        txt_enrolled = generate_stage_text("Enrolled", enrolled, eligible),
        txt_hiv = generate_stage_text("HIV+ (WLWH)", hiv, enrolled),
        txt_pm = generate_stage_text("PM+", pm_participants, hiv),
        txt_tele = generate_stage_text("Telepsychiatry", tele_participants, hiv),
        txt_6weeks_postpartum = generate_stage_text("6 weeks postpartum visit", six_weeks_visit, hiv),
        txt_14weeks_postpartum = generate_stage_text("14 weeks postpartum visit", fourteen_weeks_visit, hiv),
        txt_6months_postpartum = generate_stage_text("6 months postpartum visit", six_months_visit, hiv)
    )

# Total text for ANC attendees
txt_anc <- sprintf("ANC Attendees (n=%d)", n_attendees)

# Total assessment
txt_ass <- sprintf("Assessed for Eligibility\n (n=%d, %.1f%%)", n_assessed, (n_assessed / n_attendees) * 100)

txt_arm <- counts_by_arm %>%
    mutate(
        txt = sprintf("%s\n (n=%d, %.1f%%)", dummy_arm, assessed, (assessed / n_assessed) * 100)
    ) %>%
    pull(txt)

#combine PM+ and telepsychiatry
counts_by_arm <- counts_by_arm %>%
    mutate(
        txt_pm_tele = paste(txt_pm, txt_tele, sep = "\n")
    )

generate_box_header <- function(label, numerator, denominator, decimals = 2) {
    percent <- ifelse(denominator > 0, (numerator / denominator) * 100, 0)
    sprintf("%s (n=%d, %.*f%%):", label, numerator, decimals, percent)
}

# Build exclusion string per arm
exclusion_side_boxes <- consort_data %>%
    filter(!is.na(exclusion)) %>%
    group_by(dummy_arm, exclusion_reason = exclusion) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>% 
            select(dummy_arm, excluded, assessed),
        by = "dummy_arm"
    ) %>%
    group_split(dummy_arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$dummy_arm)
        excluded <- unique(df_arm$excluded)
        assessed <- unique(df_arm$assessed)
        
        # Header line (no real line break)
        header <- generate_box_header("Excluded", excluded, assessed)
        
        # Bullet lines (keep \\n as character)
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / excluded) * 100)
            },
            df_arm$exclusion_reason,
            df_arm$count
        )
        
        # Combine header + bullets with literal \n characters
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_ex <- unlist(exclusion_side_boxes)

# Build decline side boxes per arm
decline_side_boxes <- consort_data %>%
    filter(!is.na(rct_decline_reason)) %>%
    group_by(dummy_arm, decline_reason = rct_decline_reason) %>%
    summarise(count = n(), .groups = "drop") %>%
    left_join(
        counts_by_arm %>%
            mutate(declined = eligible - enrolled) %>%
            select(dummy_arm, declined, eligible),
        by = "dummy_arm"
    ) %>%
    group_split(dummy_arm) %>%
    lapply(function(df_arm) {
        arm_label <- unique(df_arm$arm)
        declined <- unique(df_arm$declined)
        eligible <- unique(df_arm$eligible)
        
        # Header line (with real line break later)
        header <- sprintf("Declined Enrollment (n=%d, %.1f%%):", declined, (declined / eligible) * 100)
        
        # Bullet lines with Unicode bullets and percentages
        reason_lines <- mapply(
            function(reason, count) {
                sprintf("\u2022 %s (n=%d, %.1f%%)", reason, count, (count / declined) * 100)
            },
            df_arm$decline_reason,
            df_arm$count
        )
        
        # Combine header + bullets with **real line breaks**
        box_text <- paste(c(header, reason_lines), collapse = "\n")
        
        box_text
    })

# Combine into character vector
txt_decline <- unlist(decline_side_boxes)

consort_per <- add_box(txt = txt_anc) |>
    add_box(txt = txt_ass) |>
    add_split(txt = txt_arm) |>
    #add_side_box(txt = txt_ex) |>
    add_box(txt = counts_by_arm$txt_eligible) |>
    #add_side_box(txt = txt_decline) |>
    add_box(txt = counts_by_arm$txt_enrolled) |>
    add_box(txt = counts_by_arm$txt_hiv) |>
    add_side_box(txt= counts_by_arm$txt_pm_tele) |>
    add_box(txt = counts_by_arm$txt_6weeks_postpartum) %>% 
    add_box(txt = counts_by_arm$txt_14weeks_postpartum) %>% 
    add_box(txt = counts_by_arm$txt_6months_postpartum)


consort_per
                
```

\newpage

# 4. Ineligibility

Women were ineligible if their gestational age at eligibility assessment was <20 weeks, if they endorsed thoughts/actions of self-harm, and if they endorsed symptoms of potential psychosis (e.g., hearing voices that others cannot hear, holding unusual beliefs, or feeling watched/followed), or if they endorsed experiencing memory problems.


```{r subcohort_prog, echo=FALSE, message=FALSE, warning=FALSE}
source("Consort.R")
arm_ineligibility_summary
```

\newpage

# 5. Baseline Demographics

## 5.1 Participant Baseline Demographics

```{r demographics, warning=F}

source("PPW RCT Basic Demographics.R")

arm_demo
```

\newpage
## 5.2 WLWH Cohort Baseline Demographics

Participant characteristics are generally (similar/different) across arms.
```{r WLWH_demo, echo=FALSE}
source("PPW RCT Basic Demographics.R")
arm_wlwh_demo

```

\newpage

# 6. Study Terminations
```{r Ealiest Expected termination}
first_6ths <- ppw_rct_df %>%
    # Filter to "6 months" and grab the first per participant
  filter(clt_visit == "6 months post-partum") %>%
    mutate(
    clt_timestamp = as_date(clt_date, format = "%Y-%m-%d")) %>% 
  group_by(clt_ptid) %>%
  slice_min(clt_date, n = 1) %>%    # in case there are duplicates
  ungroup() %>% 
    select(clt_study_site,clt_ptid, clt_date)

# First six-month visit date across participants
earliest_due <- first_6ths %>%
  slice_min(clt_date, n = 1) %>%
  select(clt_ptid, clt_date) %>% 
    pull(clt_date) 

total_exits <- ppw_rct_df%>%
    # Filter to "6 weeks" and grab the first per participant
  filter(clt_visit == "6 months post-partum") %>% 
    mutate(
    dummy_arm = case_when(
      grepl("Control", redcap_event_name) ~ "Arm X",
      TRUE ~ "Arm Y"
    )
  )

completed_follow_up <- total_exits %>% 
    filter(dis_today == "Yes") %>% 
    nrow()

completed_follow_upX <- total_exits %>% 
    filter(dummy_arm == "Arm X") %>% 
    select(clt_ptid, dis_today) %>% 
    filter(dis_today == "Yes") %>% 
    nrow()
    
completed_follow_upY <- total_exits %>% 
    filter(dummy_arm == "Arm Y") %>% 
    select(clt_ptid, dis_today) %>% 
    filter(dis_today == "Yes") %>% 
    nrow()

```

To date, we have not recorded any early terminations. However, `r completed_follow_up` participants have exited the study as scheduled at the end of follow-up. The first termination occurred on `r earliest_due`. Of which, `r completed_follow_upX` and `r completed_follow_upY` were from arm X and arm Y respective. 


\newpage
# 7. Referrals

## 7.1 Psychosocial Referrals

```{r message=FALSE, warning=FALSE, include=FALSE}
source("PPW RCT Referrals.R")

total_visits <- referral_df %>%nrow()
total_scr_num <- df_long %>% nrow()
total_scr_per <- round(total_scr_num/total_visits *100, 1)
total_ref_num <- df_long %>% filter(referral_accept == "Yes") %>% nrow()
total_ref_per <- round(total_ref_num/total_scr_num *100, 1)

```


During enrollment and follow-up visits participants are asked if they would like to be referred for psychosocial support if they screen positive for depression, anxiety and intimate partner violence (IPV). Out of `r total_visits` total study visits, `r total_scr_num` (`r total_scr_per`%) participants have screened positive for  referable conditions. Of which, `r total_ref_num` (`r total_ref_per`%) have accepted referrals.


```{r referrals, echo=FALSE, message=FALSE, warning=FALSE}
## generate report using data from psychosocial referrals form in REDCap  
source("PPW RCT Referrals.R")

arm_referral_summary
```


## 7.2 Treatment Referrals
```{r treatment_referrals_numsource, echo=FALSE, message=FALSE, warning=FALSE}
source("Telepsychiatry Sessions.R")
# Summarise ANC attendees and extract the sum as a numeric value
Attendees <- daily_closeout_df %>%
    summarise(`anc attendees` = sum(rct_anc_number, na.rm = TRUE)) %>%
    pull(`anc attendees`)  # Extract the sum value as a number
```

During this study period, `r Attendees` women attended MCH in the study clinics and were screened for PMAD symptoms, of whom `r screened_pmad` (`r round(screened_pmad / Attendees *100,1)`%) screened positive for PMAD. Among these, `r PM_referrals`(`r round (PM_referrals / screened_pmad *100,1)`%) had moderate symptoms in either PHQ9 or GAD7 and were referred to PM+, and `r telep_referrals` (`r round (telep_referrals / screened_pmad * 100,1)`%) had severe symptoms and were referred to psychiatrist.


```{r treatment_referrals, echo=FALSE, message=FALSE, warning=FALSE}
source("Telepsychiatry Sessions.R")
#Generate a table/figure depicting stepped care intervention steps ???Screening,  PM+,  telepsychiatry tracking (kind of ???fidelity??? to intervention model) 
fidelity_summary

```

\newpage
# 8. Serious Adverse Events

```{r Summary of SAEs}
source("SAEs Lists.R")
sae_summary

```

\newpage
# 9. Adverse Events
## 9.1 Adverse Events Summary

```{r ae_summary_morcohort, echo=FALSE}
source("SAEs Lists.R")
ae_tbl
```



### 9.1.1 List of AEs: Arm X 

```{r ArmX_AEs, echo=FALSE, fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
source("SAEs Lists.R")
armx_aes_gt
```

### 9.1.2 List of AEs: Arm Y 

```{r ArmY_AEs, echo=FALSE, fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
source("SAEs Lists.R")
army_aes_gt
```











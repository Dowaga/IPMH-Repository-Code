---
title: "IPMH_Audit_Feedback"
author: "Yuwei Wang"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, echo = F, include = F, warning=F}
rm(list = ls())

source("Audit and feedback script.R")
```

This script generates the audit and feedback report for each facility based on the calendar months. For the first audit and feedback session, we will report statistics from *March 1st* till *April 30th*. Data from the report should be abstracted for each facility and put into the slide template.

# 1. PHQ2 and GAD2 Screening Rate Per Facility (Per month & March and April Combined)

```{r, bar plots for each facility, echo = F, warning=F, fig.width = 5, fig.height = 4}
facilities <- unique(screening_rate_monthly$study_site)

for (facility in facilities) {
  facility_data <- screening_rate_monthly %>%
    filter(study_site == facility) %>%
    mutate(
      total_label = ifelse(`PHQ2/GAD2 screening rate` < 100, paste0(`Monthly ANC clients`), NA)
    )
  
  p <- ggplot(facility_data, aes(x = as.factor(month))) +
    geom_col(aes(y = 1), fill = "lightgray", width = 0.8) +
    geom_col(aes(y = `PHQ2/GAD2 screening rate` / 100), fill = "skyblue", width = 0.8) +
    
    # Add num_screened label (on blue bar)
    geom_text(aes(y = `PHQ2/GAD2 screening rate` / 100, label = `Monthly screening`),
              vjust = -0.5, size = 3) +
    
    # Add percentage label (inside blue bar)
    geom_text(aes(y = `PHQ2/GAD2 screening rate` / 100, label = paste0(round(`PHQ2/GAD2 screening rate`, 1), "%")),
              vjust = 1.5, color = "white", size = 3) +
    
    # Add total_anc_clients label only when rate < 100%
    geom_text(aes(y = 1.05, label = total_label),
              na.rm = TRUE, size = 3, color = "black") +
    
    labs(title = paste("Monthly PHQ2/GAD2 Screening Rate\n -", facility),
         x = "Month", 
         y = "Proportion of Total ANC Clients (100%)") +
    theme_minimal() +
    theme(axis.text.x = element_text(hjust = 1),
          plot.title = element_text(size = 12, hjust = 0.5)) +
    scale_y_continuous(labels = scales::percent, limits = c(0, 1.2))  # extra space for total label
  
  print(p)
}
```

```{r, monthly screening rate table, echo = F, warning=F}
kable(screening_rate_monthly, 
      caption = "Monthly PHQ2/GAD2 Screening Rate by Facility",
      digits = 2) 
```

```{r, total screening rate table per facility, echo = F, warning=F}
kable(total_screening_rate, 
      caption = "March and April Combined PHQ2/GAD2 Screening Rate by Facility",
      digits = 2)
```

\newpage

# 2. PHQ9 and GAD7 Screening Rate Among Study Participants Per Facility (Per month & March and April Combined)

```{r, phq9 bar plots for all facilities, echo = F, warning=F, fig.width=6, fig.height=4, include=F}
facilities <- unique(phq9_screening$clt_study_site)

for (facility in facilities) {
  facility_data <- phq9_screening_weekly %>% filter(clt_study_site == facility)
  
  p <- ggplot(facility_data, aes(x = week, y = `PHQ9/GAD7 screening rate`)) +
    geom_line(color = "blue") + 
    geom_point(color = "red") +
    labs(title = paste("Weekly PHQ9/GAD7 Screening Rate -", facility),
         x = "Date", 
         y = "PHQ9/GAD7 Screening Rate (%)") +
    theme_minimal() +
    theme(axis.text.x = element_text(hjust = 1),
          plot.title = element_text(size = 12)) +
    scale_x_date(date_breaks = "1 week", date_labels = "%Y-%m-%d") +
    scale_y_continuous(limits = c(0, 100))
  
  print(p)  # This will generate separate plots for each facility
}
```

```{r, monthly secondary screening rate table, echo = F, warning=F}
kable(phq9_screening_monthly, 
      caption = "PHQ9/GAD7 Monthly Screening Rate by Facility",
      digits = 2)
```

```{r, total secondary screening rate table, echo = F, warning=F}
kable(phq9_screening_total, 
      caption = "March and April Combined PHQ9/GAD7 Screening Rate by Facility",
      digits = 2)
```

\newpage

# 3. PM+ Referral Rate Per Facility (Per month & March and April Combined)

```{r, pm referral rate, echo = F, warning=F}
kable(pm_referral_monthly, 
      caption = "Monthly PM+ Referral Rate by Facility",
      digits = 2) 

kable(pm_referral_total,
      caption = "March and April Combined PM+ Referral Rate by Facility",
      digits = 2) 
```

\newpage

# 4. Telepsychiatry Referral Rate Per Facility (Per month & March and April Combined)

```{r, telepsych referral rate, echo = F, warning=F}
kable(monthly_referral_summary_tele, caption = "Monthly Telepsychiatry Referral Rate by Facility",
      digits = 2) 

kable(total_referral_summary_tele, caption = "March and April Combined Telepsychiatry Referral Rate by Facility",
      digits = 2) 
```

\newpage

# 5. PM+ initiation rate per facility (Per month & March and April Combined)

```{r, pm initiation rate, echo = F, warning=F}
kable(pm_summary_session1%>% select(1,2,3,4,7), 
      caption = "Monthly PM+ Initiation Rate (Session 1) by Facility",
      digits = 2) 

kable(pm_initiation_all_merge_session1,
      caption = "March and April Combined PM+ Initiation Rate by Facility",
      digits = 2) 
```
\newpage

# 6. PM+ completion rate per facility (Since study initiation)

```{r, pm completion rate, echo = F, warning=F}
kable(pm_completion_df %>% select(1,2,3,4), 
      caption = "PM+ Completion Rate by Facility Since Study Initiation",
      digits = 2) 
```

\newpage

# 7. Telepsychiatry initiation rate per facility (Per month & March and April Combined)

```{r, tele initiation rate, echo = F, warning=F}
kable(telepsych_initiation_monthly, 
      caption = "Monthly Telepsychiatry Initiation Rate by Facility",
      digits = 2) 

kable(telepsych_initiation_total,
      caption = "March and April Combined Telepsychiatry Initiation Rate by Facility",
      digits = 2) 
```

\newpage

# 8. Frequency of conducting health talks & use of flipbook per facility (Per month & March and April Combined)

```{r health talks, echo = F, warning=F}
kable(health_talks_monthly, caption = "Monthly Health Talks & Flipbook Usage by Facility",
      digits = 2)
kable(total_health_talks, caption = "March and April Combined  Health Talks & Flipbook Usage by Facility",
      digits = 2)
```

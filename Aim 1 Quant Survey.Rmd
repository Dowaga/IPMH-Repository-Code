---
title: "IPMH Quant Survey - HCW"
author: "David Owaga & Yuwei Wang"
date: "`r Sys.Date()`"
output:
  word_document: default
---

*Warning: Please do not change the coding for the prioritization part without Yuwei's permission.*

```{r setup, echo = F, include = F}
rm(list = ls())
pacman::p_load(knitr, tidyverse, ggplot2, psych, janitor, dplyr, 
               openxlsx, gtsummary, kableExtra, ggrepel, UpSetR, funModeling, gt, mice) 

knitr::opts_chunk$set(fig.width = 10, fig.height = 12)

source("REDCap_datapull.R")
# read data
data <- aim1quant_data %>%
  filter(pt_id > 14999999) %>% 
    filter(pt_id > 15010000) # for non-specialist only. If you want all HCW, remove this line
```

## Health Care Workers Demographics

Altogether, we currently have data for `r nrow(data)` participants.

```{r Basic Demographic Summary, echo=F, message=FALSE, warning=FALSE}
hcw_demo <- data %>%
  select(record_id, starts_with("hcw_"), demographic_hcws_complete) %>%
  filter(!is.na(hcw_participant_id)) %>% 
    mutate(hcw_terms_other = case_when(
     hcw_terms_other == "" | is.na(hcw_terms_other) ~ NA_character_,
    TRUE ~  hcw_terms_other
  ))

hcw_demo <- hcw_demo %>%
  mutate(age = case_when(
      hcw_dob_uk == "Yes" ~ floor(as.numeric(hcw_cal_age)),  
      hcw_dob_uk == "No" ~ as.numeric(hcw_age), 
      TRUE ~ NA_real_)) %>% 
  mutate(hcw_sex = dplyr::recode(hcw_sex, "1" = "Male","2" = "Female")) %>% 
  mutate(hcw_education = dplyr::recode(hcw_education, 
                                       "1" = "No schooling completed",
                                       "2" = "Primary school",
                                       "3" = "Secondary school", 
                                       "4" = "Diploma", 
                                       "5" = "Bachelor's degree or higher degree"),
         hcw_education = fct_relevel(hcw_education,
                                      "Diploma", "Bachelor's degree or higher degree", "Secondary school", "Primary school")) %>%
  mutate(hcw_job = dplyr::case_when(hcw_job___1 == "Checked" ~ "Medical officer", 
                                 hcw_job___2 == "Checked" ~ "Psychiatrists", 
                                 hcw_job___3 == "Checked" ~  "Obstetrician/gynaecologist",
                                 hcw_job___4 == "Checked"~ "Clinical officer", 
                                 hcw_job___5 == "Checked" ~ "Nurses", 
                                 hcw_job___6 == "Checked"~ "Psychologist", 
                                 hcw_job___7 == "Checked" ~ "Mental health social worker", 
                                 hcw_job___8 == "Checked" ~ "Other social worker", 
                                 hcw_job___9 == "Checked" ~ "HTS counsellor", 
                                 hcw_job___10 == "Checked" ~ "Community health worker", 
                                 hcw_job___11 == "Checked" ~ "Mentor mother", 
                                 hcw_job___12 == "Checked" ~ "Other",
                                 TRUE ~ NA_character_),
         hcw_job = fct_relevel(hcw_job, 'Medical officer', 'Psychiatrists', 'Obstetrician/gynaecologist', 'Clinical officer', 'Nurses', 'Psychologist', 'Mental health social worker', 'Other social worker', 'HTS counsellor', 'Community health worker', 'Mentor mother', 'Other')) %>%
  mutate(hcw_wlwh = dplyr::recode(hcw_wlwh, "0" = "No","1" = "Yes")) %>% 
  mutate(hcw_terms = dplyr::recode(hcw_terms, 
                                   "1" = "Permanent and pensionable", 
                                   "2" = "Contract","3" = "Volunteer", 
                                   "4" = "Other"),
         hcw_terms = fct_relevel(hcw_terms,
                                 "Contract", "Permanent and pensionable", 
                                 "Volunteer", "Other")) %>% 
  mutate(hcw_facility = dplyr::recode(hcw_facility, 
                                    "0" = "Specialist",
                                   "1" =	"Rwambwa Sub-county Hospital",
                                   "2" = 	"Sigomere Sub County Hospital",
                                   "3" =	"Uyawi Sub County Hospital",
                                   "4" = "Got Agulu Sub-District Hospital",
                                   "5" = "Ukwala Sub County Hospital",
                                   "6" = "Madiany Sub County Hospital",
                                   "7" =	"Kabondo Sub County Hospital",
                                   "8" = "Mbita Sub-County Hospital",
                                   "11" =	"Nyandiwa Level IV Hospital",
                                   "13" = "Ober Kamoth Sub County Hospital",
                                   "14" = "Gita Sub County Hospital",
                                   "15" =	"Akala Health Centre",
                                   "16" =	"Usigu Health Centre",
                                   "17" = "Ramula Health Centre",
                                   "18" =	"Simenya Health Centre",
                                   "19" =	"Airport Health Centre (Kisumu)",
                                   "20" =	"Nyalenda Health Centre",
                                   "21" = "Mirogi Health Centre",
                                   "22" = "Ndiru Level 4 Hospital")) %>% 
  mutate(hcw_hrscare = as.numeric(hcw_hrscare)) %>% 
  mutate(hcw_yearjob = hcw_yrsjob/12) %>% 
  mutate(hcw_yearwork = hcw_monthswork/12) %>% 
  mutate(hcw_yearcare = hcw_yrscare/12)

#propmiss(hcw_demo)

# basic demo table
hcw_demo %>% tbl_summary(
  include=c(age, hcw_sex, hcw_education,hcw_job,  hcw_care, hcw_dpt___2, 
            hcw_dpt___1, hcw_dpt___4, hcw_dpt___5, hcw_dpt___3, hcw_dpt___6, 
            hcw_yearjob, hcw_yearwork, hcw_terms,hcw_terms_other, hcw_wlwh, hcw_yearcare, 
            hcw_hrscare),
  label = list(age ~ "Age (Years)",
               hcw_sex ~ "Gender",
               hcw_education ~ "Education level",
               hcw_dpt___1 ~ "Working in antenatal care",
               hcw_dpt___2 ~ "Working in postnatal care",
               hcw_dpt___3 ~ "Working in immunization clinic",
               hcw_dpt___4 ~ "Working in PMTCT",
               hcw_dpt___5 ~ "Working in family planning clinic",
               hcw_dpt___6 ~ "Working in other department",
               hcw_job ~ "Current Designation",
               hcw_yearjob ~ "Current job duration (Years)",
               hcw_yearwork ~ "Duration in the facility (Years)",
               hcw_terms ~ "Terms of engagement in the facility",
               hcw_yearcare ~ "Duration of offering care to PW in the facility (Years)",
               hcw_hrscare ~ "Hours/week taking care of PW in the facility", 
               hcw_wlwh ~ "Currently providing care to PW living with HIV",
               hcw_care ~ "Offering care to perinatal women",
               hcw_terms_other ~ "Other terms of engagement"),
  missing = "no",
  digits = list(all_continuous() ~ 1), 
  type = list(age ~ "continuous", 
              hcw_hrscare ~ "continuous",
              hcw_yearjob ~ "continuous", 
              hcw_yearwork~ "continuous", 
              hcw_yearcare~ "continuous", 
              hcw_hrscare ~ "continuous"),
  statistic = list(all_continuous() ~ "{median} [IQR: {p25}, {p75}]")) %>% 
  bold_labels() %>%
  # convert from gtsummary object to gt object
  as_gt() %>%
  # modify with gt functions
  gt::tab_header("Table 1: Basic Demographic Summary for HCWs") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 
```


## Screening

```{r Grouping others who should screen, echo=FALSE, message=FALSE, warning=FALSE}
data <- data %>%
  mutate(screen_who_other = case_when(
    grepl("Adherence counsellor|Adherence counsellor.|Adherence counsellors|Adherence counsellor, CHVs.|Adherence counselors|Adherence counsellor, CHVs|Adherence", screen_who_other, TRUE ~ screen_who_other) ~ "Adherence Counsellor",
    grepl("Adherence counsellor, peer educator|Peer Educator|Peer educators|Peer educators , adherence counselors", screen_who_other, ignore.case = TRUE) ~ "Peer Educators",
    grepl("Triage clerks", screen_who_other, ignore.case = TRUE) ~ "Triage Clerks",
    grepl("Receptionist", screen_who_other, ignore.case = TRUE) ~ "Receptionist",
    grepl("Lab tech", screen_who_other, ignore.case = TRUE) ~ "Lab Technologist",
    screen_who_other == "" | is.na(screen_who_other) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ screen_who_other  # Keep original value if no match
  ))%>% 
    mutate(screen_who_other = fct_relevel(screen_who_other,
                                             "Adherence Counsellor", "Peer Educators", "Triage Clerks", "Lab Technologist", "Receptionist"))


# Others to Screen PMAD in PWLHIV
data <- data %>%
  mutate(screen_who_other_hiv = case_when(
    grepl("Adherence counsellor|Adherence counsellor.|Adherence counsellors|Adherence counselors|Adherence|Adherence counsellor, CHVs", screen_who_other_hiv, TRUE ~ screen_who_other_hiv) ~ "Adherence Counsellor",
    grepl("Peer Educator|Peer educators|Peer educator|Peer educators|adherence counselors", screen_who_other_hiv, ignore.case = TRUE) ~ "Peer Educator",
    grepl("Triage clerks", screen_who_other_hiv, ignore.case = TRUE) ~ "Triage Clerks",
    grepl("Receptionist", screen_who_other_hiv, ignore.case = TRUE) ~ "Receptionist",
    grepl("Lab tech", screen_who_other_hiv, ignore.case = TRUE) ~ "Lab Technologist",
    screen_who_other_hiv == "" | is.na(screen_who_other_hiv) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ screen_who_other_hiv  # Keep original value if no match
  ))%>% 
    mutate(screen_who_other_hiv = fct_relevel(screen_who_other_hiv,
                                             "Adherence Counsellor", "Peer Educator", "Triage Clerks", "Lab Technologist", "Receptionist"))

```


```{r Grouping other screening tools, echo=FALSE, message=FALSE, warning=FALSE}
data <- data %>%
  mutate(screen_tool_other = case_when(
    grepl("BDI", screen_tool_other, ignore.case = TRUE) ~ "Beck's Depression Inventory (BDI)",
    grepl("GBV", screen_tool_other, ignore.case = TRUE) ~ "GBV Screening Tool",
    grepl("BHTS", screen_tool_other, ignore.case = TRUE) ~ "HTS Screening",
    screen_tool_other == "" | is.na(screen_tool_other) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ screen_tool_other  # Keep original value if no match
  ))

```


```{r PMAD Screening Summary, echo=FALSE, message=FALSE, warning=FALSE}
screening <- data %>% 
    filter(hcw_care == "Yes") %>% 
    mutate(hcw_care = recode(hcw_care,
                             "1" = "Yes",
                             "0" = "No"),
           screen_role = recode(screen_role,
                                "1" = "Yes",
                                "0" =  "No",
                                "-2" =  "No answer",
                               "99" = "I don't know"),
           screen_role = fct_relevel(screen_role,
                                             "Yes", "No", "I don't know"),
           hcw_care = fct_relevel(hcw_care,
                                  "Yes", "No"),
           screen_time = recode(screen_time,
                                "1" = "This week",
                                "2" = "Last week",
                                "3" = "A month ago",
                                "4" = "More than a month ago",
                                "5" = "I don't remember"),
           screen_time = fct_relevel(screen_time,
                                             "This week", "More than a month ago", "Last week", "A month ago", "I don't remember"),
           screen_times = recode(screen_times,
                                "1" = "Less than 2 times",
                                "2" = "3 to 4 times",
                                "3" = "5 to 6 times",
                                "4" = "More than 6 times"),
           screen_times = fct_relevel(screen_times,
                                      "More than 6 times", "Less than 2 times", "3 to 4 times", "5 to 6 times")) 


screening %>% select(screen_provision, screen_hiv, screen_provision_now, screen_hiv_now,
            screen_time, screen_time, screen_times, screen_tool___3, screen_tool___1, screen_tool___5, screen_tool___2, screen_tool___4, screen_tool___8, screen_tool_other,  screen_long,  screen_who___4,  screen_who___5,  screen_who___7,  screen_who___8,  screen_who___9,  screen_who___2,  screen_who___3,  screen_who___1,  screen_who___6,  screen_who___99,  screen_who___11,  screen_who___12, screen_who_other,  screen_who_hiv___4, screen_who_hiv___5, screen_who_hiv___7, screen_who_hiv___8, screen_who_hiv___9, screen_who_hiv___99, screen_who_hiv___11, screen_who_hiv___12, screen_who_other_hiv, screen_role) %>% 
     tbl_summary(
         percent = "cell",
         label = list(
             screen_who___1 ~ "Psychiatrist",
             screen_who___2 ~ "Psychologist",
             screen_who___3 ~ "Social Worker",
             screen_who___4 ~ "Nurse", 
             screen_who___5 ~ "Clinical Officer",
             screen_who___6 ~ "Medical Officer",
             screen_who___7 ~ "HTS counsellor", 
             screen_who___8 ~ "Mentor mother",
             screen_who___9 ~ "Community Health Worker",
             screen_who___99 ~ "I don't know",
             screen_who___11 ~ "No one",
             screen_who___12 ~ "Other",
             screen_who_other ~ "Others to provide PMAD screening to PW",
             screen_provision ~ "Ever provided PMAD screening to PW",
             screen_hiv ~ "Ever provided PMAD screening to PWLHIV",
             screen_provision_now ~ "Ever provided PMAD screening to PW in the current Facility",
             screen_hiv_now ~ "Ever provided PMAD screening to PWLHIV in the current Facility",
             screen_time ~ "Last time screened PW for PMAD",
             screen_times ~ "Frequency of screening PW for PMAD in this facility in the past 2 months",
             screen_role ~ "Is it your role to screen for PMAD",
             screen_tool___1 ~ "No specific tool",
             screen_tool___2 ~ "PHQ2",
             screen_tool___3 ~ "PHQ9",
             screen_tool___4 ~ "GAD-2",
             screen_tool___5 ~ "GAD-7",
             screen_tool___8 ~ "Other",
             screen_tool_other ~ "Other PMAD screening tools",
             screen_long ~ "PMAD screening duration",
             screen_who_hiv___4 ~ "Nurse", 
             screen_who_hiv___5 ~ "Clinical Officer",
             screen_who_hiv___7 ~ "HTS counsellor", 
             screen_who_hiv___8 ~ "Mentor mother",
             screen_who_hiv___9 ~ "Community Health Worker",
             screen_who_hiv___99 ~ "I don't know",
             screen_who_hiv___11 ~ "No one",
             screen_who_hiv___12 ~ "Other",
             screen_who_other_hiv ~ "Others to provide PMAD screening to PWLHIV"),
         missing = "no",
         digits = list(all_continuous() ~ 1),
         statistic = list(all_continuous() ~ "{median} [IQR: {p25}, {p75}]")) %>%
    bold_labels() %>% 
    add_n() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("Table 2: PMAD screening") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 

```


```{r PMAD screening tools used/do use, echo=FALSE, message=FALSE, warning=FALSE}
data %>% 
    filter(hcw_care == "Yes") %>%
    filter(screen_provision_now == "Yes" | screen_hiv_now == "Yes") %>% 
    tbl_summary(
        include = c(screen_tool___3, screen_tool___1, screen_tool___5, 
                    screen_tool___2, screen_tool___4, screen_tool___8),
        label = list(screen_tool___1 ~ "No specific tool", 
                     screen_tool___2 ~ "PHQ2", 
                     screen_tool___3 ~ "PHQ9", 
                     screen_tool___4 ~ "GAD-2", 
                     screen_tool___5 ~ "GAD-7", 
                     screen_tool___8 ~ "Other")
    ) %>% 
    bold_labels() %>% 
    add_n() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("PMAD screening Tools") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 

```


## Screening prioritization

```{r screning dataset, echo=FALSE, message=FALSE, warning=FALSE}
screen_hcw <- data %>%
  filter(!is.na(hcw_participant_id)) %>% 
  select(record_id, starts_with("screen_"), screening_hcw_complete, screening_hcw_prioritization_complete)
```

### Barriers

```{r screen_barrier_hcw, echo=F, warning=F, message=F}
screen_barrier <- screen_hcw %>% 
  select(record_id, matches("barrier|add")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- screen_barrier %>%
  pivot_longer(cols = -c(record_id, screen_barrier_other),
               names_to = c("type", "barrier"), 
               names_pattern = "screen_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "Not applicable" ~ NA_real_,
                               value == "Not at all addressable" | value == "Not at all" ~ 1,
                               value == "Somewhat addressable" | value == "A little" ~ 2,
                               value == "Addressable" | value == "Somewhat" ~ 3,
                               value == "Very addressable" | value == "Very much" ~ 4)) 

cutoff_importance <- long_data %>% 
  filter(type == "barrier") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_addressability <- long_data %>% 
  filter(type == "add") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- long_data %>%
  group_by(barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_importance = mean_value_barrier,
    se_importance = se_value_barrier,
    mean_addressability = mean_value_add,
    se_addressability = se_value_add
  ) %>% 
  mutate(se_average = (se_importance + se_addressability)/2)


stats <- stats %>% 
  mutate(barrier_detail = dplyr::recode(barrier, 
                                  "knowledge" = "Knowledge: Insufficient training or knowledge gap",
                                   "guideline" =	"Guideline: Lack of guidelines",
                                   "tool" = 	"Tool: Lack of tools",
                                   "room" =	"Room: Lack of a specific room/enough rooms",
                                   "hcwstigma" = "HCWstigma: HCW stigmatization of patients with mental illnesses",
                                   "incentive" = "Incentive: Lack of financial incentives to motivate HCW",
                                   "workload" = "Workload: Having too many clients to see",
                                   "specialist" =	"Specialist: The unavailability of psychologists/counsellors",
                                   "staff" = "Staff: Lack of a specific person to screen",
                                   "priority" =	"Priority: Lack of prioritization MH among HCW",
                                   "report" = "Report: Lack of targets or reporting requirements",
                                   "stigma" = "Stigma: Stigma whereby women not wanting to be associated with mental illness",
                                   "language" =	"Language: Language barrier between women and HCW",
                                   "fear" =	"Fear: Women's fear of opening up to HCW",
                                 "aware" = "Aware: Lack of community awareness/sensitization\n in MH such that women are unaware of the need for screening"))

ggplot(stats, aes(x = mean_importance, y = mean_addressability)) +
  geom_point(aes(color = barrier_detail, size = se_average), shape =1) + 
  scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
  scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
  geom_hline(yintercept = cutoff_addressability, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
  annotate("text", x = cutoff_importance, y = 4, label = paste0("Cutoff: ", round(cutoff_importance, 2)), hjust = -0.1) +
  annotate("text", x = 1, y = cutoff_addressability, label = paste0("Cutoff: ", round(cutoff_addressability, 2)), vjust = -1) +
  labs(title = "Barrier prioritization for screening",
       x = "Importance",
       y = "Addressability",
       color = "Barrier detail",
       size = "Average SE") +
  geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol = 2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```

### Strategies

```{r screen_stra_hcw, echo=F, warning=F, message=F}
screen_strategy <- screen_hcw %>% 
  select(record_id, matches("stra|diff")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- screen_strategy %>%
  pivot_longer(cols = -c(record_id, screen_stra_other),
               names_to = c("type", "strategy"), 
               names_pattern = "screen_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "I don't know" ~ NA_real_,
                               value == "Very hard" | value == "Major negative impact" ~ 1,
                               value == "Somewhat hard" | value == "Some negative impact" ~ 2,
                               value == "Neurtral" | value == "No impact" ~ 3,
                               value == "Somewhat easy" | value == "Some positive impact" ~ 4,
                               value == "Very easy" | value == "Major positive impact" ~ 5))

cutoff_impact <- long_data %>% 
  filter(type == "diff") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_feasiblity <- long_data %>% 
  filter(type == "stra") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- long_data %>%
  group_by(strategy, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_feasibility = mean_value_stra,
    se_feasibility = se_value_stra,
    mean_impact= mean_value_diff,
    se_impact = se_value_diff
  ) %>% 
  mutate(se_average = (se_feasibility + se_impact)/2)

stats <- stats %>%
  mutate(strategy = case_when(
    strategy == "taskshift" ~ "workload",
    TRUE ~ strategy 
  ))

stats <- stats %>% 
  mutate(strategy_detail = dplyr::recode(strategy, 
                                  "knowledge" = "Knowledge: Provide training for HCWs",
                                   "guideline" =	"Guideline: Provide screening guidelines for HCWs",
                                   "tool" = 	"Tool: Provide standardized tools for HCWs",
                                   "report" =	"Report: Provide standardized reporting structures for HCWs",
                                  "room" = "Room: Provide physical space/rooms for screening",
                                   "workload" = "Workload: Task-shifting of screening to other providers",
                                   "incentive" = "Incentive: Provide financial incentives to HCWs",
                                   "specialist" =	"Specialist: Employ specialized mental health staff",
                                   "staff" = "Staff: Allocate screening to a specific HCW\n or have a mental health desk for screening",
                                   "language" =	"Language: Provide a translator",
                                 "aware" = "Aware: Sensitize CHVs and the community about MH"))

ggplot(stats, aes(x = mean_impact, y = mean_feasibility)) +
  geom_point(aes(color = strategy_detail, size = se_average), shape =1) +
  scale_x_continuous(breaks = 1:5, limits = c(4, 5)) +
  scale_y_continuous(breaks = 1:5, limits = c(1, 5)) +
  geom_hline(yintercept = cutoff_feasiblity, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_impact, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_impact, y = 5, label = paste0("Cutoff: ", round(cutoff_impact, 2)), hjust = -0.1) +
  annotate("text", x = 4, y = cutoff_feasiblity, label = paste0("Cutoff: ", round(cutoff_feasiblity, 2)), vjust = -1) +
  labs(title = "Strategy prioritization for the screening phase",
       x = "Impact",
       y = "Feasibility",
       color = "Strategy detail",
       size = "Average SE") +
  geom_text_repel(aes(label = strategy, color = strategy_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol = 2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```

#  Diagnosis and Treatment

```{r Grouping other tools for PMAD Diagnosis, echo=FALSE, message=FALSE, warning=FALSE}
data <- data %>%
  mutate(dx_way_other = case_when(
    grepl("BDI", dx_way_other, TRUE ~ dx_way_other) ~ "Beck's Depression Inventory (BDI)",
    grepl("BAI", dx_way_other, ignore.case = TRUE) ~ "Beck's Anxiety Inventory (BAI)",
    grepl("Beck's depression inventory|Becks depression inventory", dx_way_other, ignore.case = TRUE) ~ "Beck's Depression Inventory (BDI)",
    grepl("GAD 7|GAD7", dx_way_other, ignore.case = TRUE) ~ "Generalized Anxiety Disorder 7 (GAD-7)",
    grepl("History taking", dx_way_other, ignore.case = TRUE) ~ "History Taking",
    dx_way_other == "" | is.na(dx_way_other) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ dx_way_other  # Keep original value if no match
  )) %>% 
    mutate(dx_way_other = fct_relevel(dx_way_other,
                                      "Generalized Anxiety Disorder 7 (GAD-7)", "Beck's Depression Inventory (BDI)", "Clinical Intake", "History Taking"))

data <- data %>%
  mutate(dx_way_now_other = case_when(
    grepl("BDI", dx_way_now_other, TRUE ~ dx_way_now_other) ~ "Beck's Depression Inventory (BDI)",
    grepl("BAI", dx_way_now_other, ignore.case = TRUE) ~ "Beck's Anxiety Inventory (BAI)",
    grepl("Beck's depression inventory|Becks depression inventory", dx_way_now_other, ignore.case = TRUE) ~ "Beck's Depression Inventory (BDI)",
    grepl("GAD 7|GAD7", dx_way_now_other, ignore.case = TRUE) ~ "Generalized Anxiety Disorder 7 (GAD-7)",
    grepl("History taking", dx_way_now_other, ignore.case = TRUE) ~ "History Taking",
    dx_way_now_other == "" | is.na(dx_way_now_other) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ dx_way_now_other  # Keep original value if no match
  ))%>% 
    mutate(dx_way_now_other = fct_relevel(dx_way_now_other,
                                      "Generalized Anxiety Disorder 7 (GAD-7)", "Beck's Depression Inventory (BDI)", "History Taking"))%>% 
    mutate(trt_other = case_when(
     trt_other == "" | is.na(trt_other) ~ NA_character_,
    TRUE ~  trt_other # Insert NA in other treatment use IFF is empty
  ))%>% 
    mutate(trt_other = case_when(
    grepl("Referral", trt_other, TRUE ~ trt_other) ~ "Refer to psychologist for psychotherapy",
    trt_other == "" | is.na(trt_other) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ trt_other  # Keep original value if no match
  )) %>% 
    mutate(trt_other_now = case_when(
    grepl("Referral", trt_other_now, TRUE ~ trt_other_now) ~ "Refer to psychologist for psychotherapy",
    grepl("CBT  ACT",trt_other_now, TRUE ~ trt_other_now) ~ "Cognitive behavioral therapy (CBT) and acceptance and commitment therapy (ACT)",
    trt_other_now == "" | is.na(trt_other_now) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ trt_other_now  # Keep original value if no match
  ))%>% 
    mutate(dxtrt_who_other_hiv = case_when(
    grepl("Counsellor|Adherence", dxtrt_who_other_hiv, TRUE ~ dxtrt_who_other_hiv) ~ "Adherence counsellor",
    dxtrt_who_other_hiv == "" | is.na(dxtrt_who_other_hiv) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ dxtrt_who_other_hiv  # Keep original value if no match
    ))
```


```{r Inserting NA in others columns, echo=FALSE, message=FALSE, warning=FALSE}
data <- data %>% 
    mutate(trt_coun_now = case_when(
     trt_coun_now == "" | is.na(trt_coun_now) ~ NA_character_,
    TRUE ~  trt_coun_now
  ))%>% 
    mutate(trt_other_now = case_when(
     trt_other_now == "" | is.na(trt_other_now) ~ NA_character_,
    TRUE ~  trt_other_now
  ))%>% 
    mutate(trt_med_other = case_when(
     trt_med_other == "" | is.na(trt_med_other) ~ NA_character_,
    TRUE ~  trt_med_other
    ))%>% 
    mutate(trt_diff_couns = case_when(
     trt_diff_couns == "" | is.na(trt_diff_couns) ~ NA_character_,
    TRUE ~  trt_diff_couns
    ))%>% 
    mutate(trt_hiv_other = case_when(
     trt_hiv_other == "" | is.na(trt_hiv_other) ~ NA_character_,
    TRUE ~  trt_hiv_other
    ))%>% 
    mutate(trt_med_hiv_other = case_when(
     trt_med_hiv_other == "" | is.na(trt_med_hiv_other) ~ NA_character_,
    TRUE ~  trt_med_hiv_other
    ))%>% 
    mutate(trt_who_other = case_when(
     trt_who_other == "" | is.na(trt_who_other) ~ NA_character_,
    TRUE ~ trt_who_other
    ))%>% 
    mutate(dxtrt_who_other_hiv = case_when(
     dxtrt_who_other_hiv == "" | is.na(dxtrt_who_other_hiv) ~ NA_character_,
    TRUE ~ dxtrt_who_other_hiv
    ))
as <- data %>% 
    select(dxtrt_who_hiv___12, dxtrt_who_other_hiv) %>% 
    filter(dxtrt_who_hiv___12 == 1)
```



```{r Diagnosis and Treatment, echo=FALSE, message=FALSE, warning=FALSE}
data %>% 
    filter(hcw_care == "Yes") %>% 
    mutate(dx_trt_time = recode(dx_trt_time,
                                "1" = "This week",
                                "2" =  "Last week",
                                "3" = "A month ago",
                                "4"  = "More than a month ago",
                                "5" =  "I don't remember"),
           dx_trt_time = fct_relevel(dx_trt_time, 
                                     "More than a month ago", "Last week", "A month ago", "This week", "I don't remember"),
           dx_trt_hiv_time = recode(dx_trt_hiv_time,
                                "1" = "This week",
                                "2" =  "Last week",
                                "3" = "A month ago",
                                "4"  = "More than a month ago",
                                "5" =  "I don't remember"),
           dx_trt_hiv_time = fct_relevel(dx_trt_hiv_time, 
                                     "More than a month ago", "Last week", "A month ago", "I don't remember", "This week"),
           dx_trt_hiv_times = recode(dx_trt_hiv_times,
                                 "1" = "Less than 2 times",
                                 "2" = "3 to 4 times",
                                 "3" = "5 to 6 times",
                                 "4" =  "More than 6 times"),
           dx_trt_hiv_times = fct_relevel(dx_trt_hiv_times,
                                      "Less than 2 times", "3 to 4 times", "5 to 6 times", "More than 6 times"),
           dx_trt_times = recode(dx_trt_times,
                                 "1" = "Less than 2 times",
                                 "2" = "3 to 4 times",
                                 "3" = "5 to 6 times",
                                 "4" =  "More than 6 times"),
           dx_trt_times = fct_relevel(dx_trt_times,
                                      "Less than 2 times", "3 to 4 times", "5 to 6 times", "More than 6 times"),
           dxtrt_role = recode(dxtrt_role,
                               "99" = "I don't know",
                               "1" = "Yes",
                               "0" = "No"),
           dxtrt_role = fct_relevel(dxtrt_role,
                                    "Yes", "No", "I don't know")) %>%
    select(dx_provision, dx_hiv,  dx_way___1,  dx_way___2,  dx_way___3, 
           dx_way___4,  dx_way___5, dx_way_other, dx_provision_now, 
           dx_hiv_now,  dx_way_now___1, dx_way_now___2, dx_way_now___4, 
           dx_way_now___5, dx_way_now_other,  trt_provisions,  trt_hiv,  
           trt_type___1, trt_type___2,  trt_type___3, trt_type___4, trt_other,
           trt_provision_now,  trt_hiv_now,  trt_type_now___1, 
           trt_type_now___2, trt_type_now___3, trt_type_now___4, 
           trt_other_now ,dx_trt_time, dx_trt_times,dx_trt_long, 
           dx_trt_hiv_time, dx_trt_hiv_times, dxtrt_hiv_long, 
           trt_med___1, trt_med___2, trt_med___3, trt_med___4, trt_med___5, 
           trt_diff, trt_type_hiv___2, trt_type_hiv___1, trt_type_hiv___3,
           trt_med_hiv___1,  trt_med_hiv___2, 
           trt_med_hiv___3, dx_trt_who___4,
           dx_trt_who___5, dx_trt_who___1, dx_trt_who___2, 
           dx_trt_who___6, dx_trt_who___7, dx_trt_who___8, dx_trt_who___12,
           trt_who_other, dxtrt_who_hiv___5, dxtrt_who_hiv___4, 
           dxtrt_who_hiv___1, dxtrt_who_hiv___2, dxtrt_who_hiv___6,
           dxtrt_who_hiv___7,dxtrt_who_hiv___8, dxtrt_who_hiv___99, 
           dxtrt_who_hiv___12, dxtrt_who_other_hiv, dxtrt_role) %>% 
    tbl_summary(missing = "no",
         digits = list(all_continuous() ~ 1),
         type = list(dxtrt_hiv_long ~ "continuous",
                     dx_trt_long ~ "continuous"),
         label = list(
             dx_provision ~ "Ever provided PMAD Diagnosis to PW",
             dx_hiv ~ "Ever provided PMAD Diagnosis to PWLHIV",
             dx_way___1 ~ "Clinical judgement",
             dx_way___2 ~ "PHQ9",
             dx_way___3 ~ "CESD",
             dx_way___4 ~ "DSM5",
             dx_way___5 ~ "Other",
             dx_provision_now ~ "Ever provided PMAD diagnosis to PW in current facility",
             dx_hiv_now ~ "Ever provided PMAD diagnosis to PWLHIV in current facility",
             dx_way_now___1 ~ "Clinical judgement",
             dx_way_now___2 ~ "PHQ9",
             dx_way_now___4 ~ "DSM5",
             dx_way_now___5 ~ "Other",
             trt_provisions ~ "Ever offered treatment to PW",
              trt_hiv ~ "Ever offered treatment to PWLHIV",
             trt_provision_now ~ "Ever offered treated to PW in curent Facility",
              trt_hiv_now ~ "Ever offered treated to PWLHIV in curent Facility",
             dx_trt_time ~ "Last time diagnosed and/or treated PW with PMAD",
             dx_trt_times ~ "PW PMAD diagnosis or treatment frequency in the past 2 months",
             dxtrt_role ~ "Is it your role to diagnose and/or treat PW for PMAD",
            dx_trt_hiv_time ~ "Last time diagnosed and/or treated PWLHIV with PMAD",
            dx_trt_hiv_times ~ "PWLHIV PMAD diagnosis or treatment frequency in the past 2 months",
            dxtrt_hiv_long ~ "Time to diagnose and/or treat PWLHIV with PMAD (Minutes)",
            trt_med___1 ~ "Antidepressants",
            trt_med___2 ~ "Antipsychotics",
            trt_med___3 ~ "Mood stabilizers",
            trt_med___4 ~ "Sedatives",
            trt_med___5 ~ "Other",
            trt_diff ~ "Does PMAD treatment for PW differ with HIV status?",
            dx_trt_who___1 ~ "Psychiatrist",
            dx_trt_who___2 ~ "Psychologist",
            dx_trt_who___4 ~ "Nurse",
            dx_trt_who___5 ~"Clinical Officer",
            dx_trt_who___6 ~ "Medical Officer",
            dx_trt_who___7 ~ "HTS counsellor",
            dx_trt_who___8 ~ "Mentor mother",
            dx_trt_who___12 ~ "Other",
            dxtrt_who_hiv___1 ~ "Psychiatrist",
            dxtrt_who_hiv___2 ~ "Psychologist",
            dxtrt_who_hiv___4 ~ "Nurse",
            dxtrt_who_hiv___5 ~ "Clinical Officer",
            dxtrt_who_hiv___6 ~ "Medical Officer",
            dxtrt_who_hiv___7 ~ "HTS counsellor",
            dxtrt_who_hiv___8 ~ "Mentor mother",
            dxtrt_who_hiv___99 ~ "I don't know",
            dxtrt_who_hiv___12 ~ "Others",
            dx_way_now_other ~ "Other PMAD screening tools in the current facility",
            trt_type___1 ~ "Manualized counselling",
            trt_type___2 ~ "Medication",
            trt_type___3 ~ "Unspecific counselling",
            trt_type___4 ~ "Other",
            trt_med_hiv___1 ~ "Antidepressants",
            trt_med_hiv___2 ~ "Antipsychotics",
            trt_med_hiv___3 ~ "Mood stabilizers",
            trt_type_hiv___1 ~ "Manualized counselling",
            trt_type_hiv___2 ~ "Medication",
            trt_type_hiv___3 ~ "Other",
            dx_trt_long ~ "Time to diagnose and/or treat PW with PMAD (Minutes)",
            trt_type_now___1 ~  "manualized counselling",
            trt_type_now___2 ~ "medication",
            trt_type_now___3 ~ "Unspecific Counselling",
             trt_type_now___4 ~ "Other",
            dx_way_other ~ "Other tools usedto diagnosis PMAD among PW",
            trt_other ~ "Other PMAD treatments used",
            trt_other_now ~ "Other PMAD treatments used in the current facility",
            trt_who_other ~ "Others who should diagnose or treat PW with PMAD in this facility",
            dxtrt_who_other_hiv ~ "Others who should diagnose or treat PWLHIV with PMAD in this facility" )) %>%
    modify_caption("**Diagnosis and Treatment**") %>%
    bold_labels() %>% 
    add_n() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("Table3: PMAD Diagnosis and Treatment") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 
```


```{r PW PMAD screening tools, include = F, echo=FALSE, message=FALSE, warning=FALSE}
screening_tools <- data %>% 
    filter(hcw_care == "Yes") %>%
    filter(dx_provision == "Yes" | dx_hiv == "Yes")

screening_tools %>% 
    tbl_summary(
        include = c(dx_way___1, dx_way___2, dx_way___4, dx_way___5, dx_way___3),
        label = list(
            dx_way___1 ~ "Clinical judgement",
            dx_way___2 ~ "PHQ9",
            dx_way___3 ~ "CESD",
            dx_way___4 ~ "DSM5",
            dx_way___5 ~ "Other"
        )
    )%>% 
    add_n()%>% 
    bold_labels()%>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("Tools used to diagnose PMAD among PW") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 
```




```{r PMAD screening Tools among PW in the current facility, echo=FALSE, message=FALSE, warning=FALSE, include =F}
 facility_tools <- data %>% 
    filter(hcw_care == "Yes") %>%
    filter(dx_provision_now == "Yes" | dx_hiv_now == "Yes")

facility_tools %>% 
    tbl_summary(
        include = c(dx_way_now___1, dx_way_now___2, dx_way_now___4, dx_way_now___5),
        label = list(
            dx_way_now___1 ~ "Clinical judgement",
            dx_way_now___2 ~ "PHQ9",
            dx_way_now___4 ~ "DSM5",
            dx_way_now___5 ~ "Other"
        )
    ) %>% 
    add_n()%>% 
    bold_labels()%>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("PMAD screening tools in the current facility") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 
```



```{r PMAD treatmet for PW, echo=FALSE, message=FALSE, warning=FALSE, include = F}
data %>% 
    filter(trt_provisions == "Yes" | trt_hiv == "Yes") %>% 
    tbl_summary(
        include = c(trt_type___3, trt_type___2, trt_type___1, trt_type___4),
        label = list(trt_type___1 ~ "Manualized counselling",
                      trt_type___2 ~ "Medication",
                     trt_type___3 ~ "Unspecific counselling",
                     trt_type___4 ~ "Other")
        )%>% 
    add_n() %>% 
    bold_labels() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("PW PMAD treatmet") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 

# PMAD Treatments used in the Current Facility
data %>% 
    filter(hcw_care == "Yes") %>%
    filter(trt_provision_now == "Yes" | trt_hiv_now == "Yes") %>%
    select(trt_type_now___1, trt_type_now___2, trt_type_now___3,
           trt_type_now___4) %>% 
    tbl_summary(
        label = list(trt_type_now___1 ~ "Manualized counselling",
                     trt_type_now___2 ~ "Medication",
                     trt_type_now___3 ~ "Unspecific counselling",
                     trt_type_now___4 ~ "Other")
        )%>% 
    add_n() %>% 
    bold_labels() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("PW PMAD treatmet in the Current Facility") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 
```


```{r PW PMAD Treatments, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
data %>% 
    filter(trt_provisions == "Yes" |trt_hiv == "Yes") %>% 
    tbl_summary(
        include = c(trt_type___3, trt_type___2, trt_type___1,  trt_type___4),
        label = list(
            trt_type___3 ~ "Unspecific counselling", 
            trt_type___2 ~ "Medication", 
            trt_type___1 ~ "Manualized Counselling",
             trt_type___4 ~ "Others"
        ))%>% 
    bold_labels() %>% 
    add_n() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("PW PMAD treatment") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1)) 
```

```{r Medications Prescribed, echo=FALSE, message=FALSE, warning=FALSE, include=F}
data %>% 
    filter(trt_type___2 == "Checked") %>% 
    select(trt_med___1, trt_med___2, trt_med___3, 
           trt_med___4, trt_med___5) %>% 
    tbl_summary(
        label = list(trt_med___1 ~ "Antidepressants",
                     trt_med___2 ~ "Antipsychotics",
                     trt_med___3 ~ "Mood stabilizers",
                     trt_med___4 ~ "Sedatives",
                     trt_med___5 ~ "Other")
    )%>% 
    add_n() %>% 
    bold_labels() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("PW PMAD Medications Prescribed") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1))
```


```{r Different PMAD Medication for PWLHIV, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
data%>% 
    filter(trt_type_hiv___2 == "Checked") %>% 
    select(trt_med_hiv___1, trt_med_hiv___2, trt_med_hiv___3) %>% 
    tbl_summary(,
                label = list(
                    trt_med_hiv___1 ~ "Antidepressants", 
                    trt_med_hiv___2 ~ "Antipsychotics", 
                    trt_med_hiv___3 ~ "Mood stabilizers"
                             )
                )%>% 
    add_n() %>% 
    bold_labels() %>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("Different PMAD Medication for PWLHIV") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1))
```


## Diagnosis and treatment prioritization

### Barriers

```{r dxtrt_barrier_hcw, echo=F, message=FALSE, warning=FALSE}
dxtrt_hcw <- data %>%
  filter(!is.na(hcw_participant_id)) %>% 
  select(record_id, starts_with("dxtrt"), starts_with("trt"),
         starts_with("dx"), starts_with("dx_trt"),
         diagnosis_and_treatment_hcw_complete, 
         diagnosis_and_treatment_hcw_prioritization_complete)

dxtrt_barrier <- dxtrt_hcw %>% 
  select(record_id, matches("barrier|add")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- dxtrt_barrier %>%
  mutate(dxtrt_add_denial = dxtrt_add_deny) %>%  
    select(-dxtrt_add_deny) %>%  
  pivot_longer(cols = -c(record_id, dxtrt_barrier_other, dxt_barrier_other),
               names_to = c("type", "barrier"), 
               names_pattern = "dxtrt_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "Not applicable" ~ NA_real_,
                               value == "Not at all addressable" | value == "Not at all" ~ 1,
                               value == "Somewhat addressable" | value == "A little" ~ 2,
                               value == "Addressable" | value == "Somewhat" ~ 3,
                               value == "Very addressable" | value == "Very much" ~ 4))

stats <- long_data %>%
  group_by(barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_importance = mean_value_barrier,
    se_importance = se_value_barrier,
    mean_addressability = mean_value_add,
    se_addressability = se_value_add
  ) %>% 
  mutate(se_average = (se_importance + se_addressability)/2) %>% 
  filter(!is.na(mean_importance) & !is.na(mean_addressability))

cutoff_importance <- long_data %>% 
  filter(type == "barrier") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_addressability <- long_data %>% 
  filter(type == "add") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- stats %>% 
  mutate(barrier_detail = dplyr::recode(barrier, 
                                  "knowledge" = "Knowledge: Insufficient training of CHWS\n resulting in reduced confidence to handle the cases",
                                   "guideline" =	"Guideline: Lack of guidelines",
                                   "tool" = 	"Tool: Lack of tools",
                                   "room" =	"Room: Lack of a specific room/enough rooms",
                                   "hcwstigma" = "HCWstigma: HCW stigmatization of patients with mental illnesses",
                                  "regist" = "Regist: Lack of designated facility registers to document results",
                                   "incentive" = "Incentive: Lack of financial incentives to motivate HCW",
                                   "staff" = "Staff: Lack of a specific person to diagnose and/or treat",
                                   "fund" = "Fund: Lack of funding support for diagnosis",
                                  "religion" = "Religion: Exisiting cultural beliefs and religion\n (witchcraft and services from pastors instead of HCWs)",
                                  "stigma" = "Stigma: Stigmatization from the community",
                                   "workload" = "Workload: Having too many clients to see",
                                  "fear" =	"Fear: Women's fear of opening up to HCW",
                                  "drug" = "Drug: Lmited drug supply to manage patients",
                                  "psych" = "Psych: The unavailability of psychologists/counsellors", 
                                  "denial" = "Denial: Patients' denial of PMAD",
                                  "gap" = "Gap: Lack of knowledge among clients on\n where to seek treatment services",
                                  "adhere" = "Adhere: Poor patient adherence to treatment",
                                  "transport" = "Transport: Lack of funds for transport to seek treatment",
                                  "compete" = "Compete: Patient's competing priorities"))

ggplot(stats, aes(x = mean_importance, y = mean_addressability)) +
  geom_point(aes(color = barrier_detail, size = se_average), shape =1) + 
  scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
  scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
  geom_hline(yintercept = cutoff_addressability, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
  annotate("text", x = cutoff_importance, y = 4, label = paste0("Cutoff: ", round(cutoff_importance, 2)), hjust = -0.1) +
  annotate("text", x = 1, y = cutoff_addressability, label = paste0("Cutoff: ", round(cutoff_addressability, 2)), vjust = -1) +
  labs(title = "Barrier prioritization for diagnosis and treatment",
       x = "Importance",
       y = "Addressability",
       color = "Barrier detail",
       size = "Average SE") +
  geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol = 2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))

```

### Strategies

```{r dxtrt_stra_hcw, echo=F, warning=F, message=F}
dxtrt_strategy <- dxtrt_hcw %>% 
  select(record_id, matches("stra|diff")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99))) 

long_data <- dxtrt_strategy %>%
  select(-trt_diff, -trt_diff_couns) %>% 
  mutate(dxtrt_stra_trainexist = dxtrt_stra_train_exist,
         dxtrt_stra_trainmore = dxtrt_stra_train_more,
         dxtrt_diff_trainexist = dxtrt_diff_train_exist,
         dxtrt_diff_trainmore = dxtrt_diff_train_more,
         dxtrt_stra_staff = dxtrt_stra_employ,
         dxtrt_diff_staff = dxtrt_diff_employ) %>%
  select(-dxtrt_stra_train_exist, -dxtrt_stra_train_more,
         -dxtrt_diff_train_exist, -dxtrt_diff_train_more,
         -dxtrt_stra_employ, -dxtrt_diff_employ) %>%
  pivot_longer(cols = -c(record_id, dxtrt_stra_other, dx_strategy_other),
               names_to = c("type", "strategy"), 
               names_pattern = "dxtrt_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "I don't know" ~ NA_real_,
                               value == "Very hard" | value == "Major negative impact" ~ 1,
                               value == "Somewhat hard" | value == "Some negative impact" ~ 2,
                               value == "Neurtral" | value == "No impact" ~ 3,
                               value == "Somewhat easy" | value == "Some positive impact" ~ 4,
                               value == "Very easy" | value == "Major positive impact" ~ 5))

stats <- long_data %>%
  group_by(strategy, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_feasibility = mean_value_stra,
    se_feasibility = se_value_stra,
    mean_impact= mean_value_diff,
    se_impact = se_value_diff
  ) %>% 
  mutate(se_average = (se_feasibility + se_impact)/2) %>% 
    filter(!is.na(mean_impact) & !is.na(mean_feasibility))

stats <- stats %>% 
  mutate(strategy_detail = dplyr::recode(strategy, 
                                  "trainexist" = "Trainexist: Train existing HCWs\n on diagnosis and treatment modalities for PMAD",
                                  "trainmore" = "Trainmore: Train more providers to become mental health specialists",
                                  "drug" = "Drug: Procure required drugs",
                                   "guideline" =	"Guideline: Provide guidelines for HCWs",
                                   "tool" = 	"Tool: Provide standardized tools for HCWs",
                                  "room" = "Room: Provide physical space/rooms",
                                  "regist" = "Regist: Provide facility registers to document results",
                                  "staff" = "Staff: Employ specialised MH staff",
                                  "aware" = "Aware: Sensitize CHVs and the community about MH",
                                  "partner" = "Partner: Involve partner or someone to support women",
                                  "dot" = "DOT: Provide DOT in the facility",
                                  "empower" = "Empower: Soceio-economic empowerment of women",
                                  "group" = "Group: Provide group therapy"))

cutoff_impact <- long_data %>% 
  filter(type == "diff") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_feasiblity <- long_data %>% 
  filter(type == "stra") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

ggplot(stats, aes(x = mean_impact, y = mean_feasibility)) +
  geom_point(aes(color = strategy_detail, size = se_average), shape =1) +
  scale_x_continuous(breaks = 1:5, limits = c(4.5, 5)) +
  scale_y_continuous(breaks = 1:5, limits = c(1, 5)) +
  geom_hline(yintercept = cutoff_feasiblity, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_impact, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_impact, y = 5, label = paste0("Cutoff: ", round(cutoff_impact, 2)), hjust = -0.1) +
  annotate("text", x = 4.5, y = cutoff_feasiblity, label = paste0("Cutoff: ", round(cutoff_feasiblity, 2)), vjust = -1) +
  labs(title = "Strategy prioritization for diagnosis and treatment",
       x = "Impact",
       y = "Feasibility",
       color = "Strategy detail",
       size = "Average SE") +
  geom_text_repel(aes(label = strategy, color = strategy_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol=2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```


## Referral and Remission

```{r Inserting NA in remission others columns, echo=FALSE, message=FALSE, warning=FALSE}
data <- data %>% 
    mutate(ref_where_other = case_when(
     ref_where_other == "" | is.na(ref_where_other) ~ NA_character_,
    TRUE ~  ref_where_other
  ))%>% 
    mutate(ref_diff_other = case_when(
     ref_diff_other == "" | is.na(ref_diff_other) ~ NA_character_,
    TRUE ~  ref_diff_other
  ))%>% 
    mutate(ref_who_other = case_when(
      ref_who_other == "" | is.na(ref_who_other) ~ NA_character_,
    TRUE ~   ref_who_other
  ))%>% 
    mutate(ref_who_other_hiv = case_when(
      ref_who_other_hiv == "" | is.na(ref_who_other_hiv) ~ NA_character_,
    TRUE ~ ref_who_other_hiv
  ))%>% 
    mutate(ref_who_other = case_when(
    grepl("Adherence counsellor", ref_who_other, TRUE ~  ref_who_other) ~ "Adherence counselors",
    ref_who_other == "" | is.na(ref_who_other) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ ref_who_other  # Keep original value if no match
  ))%>% 
    mutate(ref_who_other_hiv = case_when(
        grepl("Adherence counsellor", ref_who_other_hiv, TRUE ~  ref_who_other_hiv) ~ "Adherence counselors",
        grepl("CCC", ref_who_other_hiv, TRUE ~  ref_who_other_hiv) ~ "CCC staff",
    ref_who_other_hiv == "" | is.na(ref_who_other_hiv) ~ NA_character_,  # Set to NA if empty or NA
    TRUE ~ ref_who_other_hiv  # Keep original value if no match
    ))
```


```{r Referral and Remission Summary, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
refremis_hcw <- data %>%
    filter(hcw_care == "Yes") %>% 
  filter(!is.na(hcw_participant_id)) %>% 
  select(record_id, starts_with("ref_"), starts_with("remis_"), starts_with("refremis_"),
         starts_with("refmis_"), referral_and_remission_hcw_complete) %>% 
    mutate(ref_where_other = case_when(
     ref_where_other == "" | is.na(ref_where_other) ~ NA_character_,
    TRUE ~  ref_where_other
  ))

refremis_hcw <- refremis_hcw %>% 
  mutate(ref_remis_time = dplyr::recode(ref_remis_time, 
                                       "1" = "This week",
                                       "2" = "Last week",
                                       "3" = "A month ago", 
                                       "4" = "More than a month ago", 
                                       "5" = "I don't remember")) %>%
  mutate(ref_remis_times = dplyr::recode(ref_remis_times, 
                                       "1" = "Less than 2 times",
                                       "2" = "3 to 4 times",
                                       "3" = "5 to 6 times", 
                                       "4" = "More than 6 times")) %>%
  mutate(ref_role = dplyr::recode(ref_role, 
                                       "1" = "Yes",
                                       "0" = "No",
                                       "-2" = "No answer", 
                                       "99" = "I don't know"))

# convert 0 in HIV referral to NA iff referral currently ==0
refremis_hcw <- refremis_hcw %>%
  mutate(ref_provision_hiv = ifelse(ref_provision_now == "No", NA, ref_provision_hiv))

other <- refremis_hcw %>% 
    filter(ref_where___5 == "Checked") %>% 
    select(ref_where_other)

# Other referrals
refremis_hcw <- refremis_hcw %>%
  mutate(ref_where_other = case_when(
    grepl("Mathare|Mtrh|Mathari", ref_where_other, ignore.case = TRUE) ~ "Mathare National Teaching and Referral Hospital",
    grepl("Bondo", ref_where_other, ignore.case = TRUE) ~ "Bondo Sub-County Hospital",
    grepl("Madiany", ref_where_other, ignore.case = TRUE) ~ "Madiany Sub-County Hospital",
    grepl("psychiatric review", ref_where_other, ignore.case = TRUE) ~ "Booking for Psychiatric review",
    grepl("Kendu adventist hospital", ref_where_other, ignore.case = TRUE) ~ "Kendu Adventist Hospital",
    grepl("Yala", ref_where_other, ignore.case = TRUE) ~ "Yala Sub-County Hospital",
    grepl("Kayole", ref_where_other, ignore.case = TRUE) ~ "Kayole Health Centre",
    grepl("Chulaimbo", ref_where_other, ignore.case = TRUE) ~ "Chulaimbo Sub-County Hospital",
    grepl("Rachuonyo", ref_where_other, ignore.case = TRUE) ~ "Rachuonyo Sun-County Hospital",
    grepl("Within", ref_where_other, ignore.case = TRUE) ~ "Within the facility",
    TRUE ~ ref_where_other,  # Keep original value if no match
  ref_where_other == "" | is.na(ref_where_other) ~ NA_character_,  # Set to NA if empty or NA
    )) %>% 
    mutate(ref_remis_time = fct_relevel(ref_remis_time,
                                         "More than a month ago", "A month ago",
                                        "I don't remember", "Last week", "This week"),
           ref_remis_times = fct_relevel(ref_remis_times, 
                                         "Less than 2 times", "3 to 4 times", 
                                         "More than 6 times", "5 to 6 times"),
           ref_role = fct_relevel(ref_role,
                                  "Yes", "No", "I don't know"))


refremis_hcw %>% tbl_summary(
  include=c(ref_provision, ref_provision_now, ref_provision_hiv, ref_where___1,
            ref_where___2, ref_where___3, ref_where___4, ref_where___5, 
            ref_where_other, ref_where_hiv_diff, ref_where_hiv_diff, ref_where_diff_hiv___5, remis_provision, 
            remis_provision_now, remis_hiv, ref_remis_time,  ref_remis_times, 
            ref_who___5, ref_who___4, ref_who___6, ref_who___2, ref_who___1, 
            ref_who___7, ref_who___9, ref_who___3, ref_who___8, ref_who___12,
            ref_who_other, ref_who_hiv___5, ref_who_hiv___4, ref_who_hiv___6, 
            ref_who_hiv___2, ref_who_hiv___1, ref_who_hiv___7,
            ref_who_hiv___9, ref_who_hiv___8, ref_who_hiv___12, 
            ref_who_other_hiv, ref_who_hiv___99,  ref_role),
  label = list(ref_provision ~ "Ever provided PMAD referral to PW",
               ref_provision_now ~ "Providing PMAD referral currently",
               ref_where___1 ~ "Jaramogi Oginga Odinga TRH",
               ref_where___2 ~ "Homa Bay TRH",
               ref_where___3 ~ "Siaya TRH",
               ref_where___4 ~ "Kisumu CRH",
               ref_where___5 ~ "Other facilities",
               remis_provision ~ "Ever assessed PMAD remission",
               remis_provision_now ~ "Assessing PMAD remission currently",
               remis_hiv ~ "Ever assessed PMAD remission among PWLHIV",
               ref_remis_time ~ "Last time to refer or assess remission",
               ref_remis_times ~ "Times to refer or assess remission\n in the last two months",
               ref_role ~ "Is it your role to refer or assess remission?",
               ref_where_hiv_diff ~ "Is the referral facility for PW and PWLHIV the same?",
               ref_provision_hiv ~ "Ever provided PMAD referral services for PWLHIV",
               ref_where_other ~ "Other PW referral Facilities",
               ref_where_diff_hiv___5 ~ "Other facilities",
               ref_who___5 ~ "Clinical Officer", 
               ref_who___4 ~ "Nurse", 
               ref_who___6 ~ "Medical Officer", 
               ref_who___2 ~ "Psychologist", 
               ref_who___1 ~ "Psychiatrist", 
               ref_who___7 ~ "HTS counsellor", 
               ref_who___9 ~ "Community Health Worker", 
               ref_who___3 ~ "Social worker", 
               ref_who___8 ~ "Mentor mother", 
               ref_who___12 ~ "Other",
               ref_who_hiv___5 ~ "Clinical Officer", 
               ref_who_hiv___4 ~ "Nurse", 
               ref_who_hiv___6 ~ "Medical Officer", 
               ref_who_hiv___2 ~ "Psychologist", 
               ref_who_hiv___1 ~ "Psychiatrist", 
               ref_who_hiv___7 ~ "HTS counsellor",
               ref_who_hiv___9 ~ "Community Health Worker", 
               ref_who_hiv___8 ~ "Mentor mother", 
               ref_who_hiv___12 ~ "Other", 
               ref_who_hiv___99 ~ "I don't know",
               ref_who_other ~ "Others to provide referral and assess remission for PMAD to PW in this facility",
               ref_who_other_hiv ~ "Others to provide referral and assess remission for PMAD to PWLHIV in this facility"),
  missing = "no",
  digits = list(all_continuous() ~ 1),
  statistic = list(all_continuous() ~ "{mean}  {sd}")) %>% 
    add_n() %>% 
    bold_labels()%>%
  # convert from gtsummary object to gt object
  as_gt() %>%
  # modify with gt functions
  gt::tab_header("**Table 4: Referral or remission assessment provision and condition**") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1))
```


```{r Where do you normally refer women to?, echo=FALSE, message=FALSE, warning=FALSE}
refremis_hcw %>% 
    filter(ref_provision_now == "Yes") %>% 
    select(ref_where___3, ref_where___4, ref_where___2, ref_where___1, 
           ref_where___5) %>% 
    tbl_summary(
        label = list(
            ref_where___1 ~ "Jaramogi Oginga Odinga TRH",
            ref_where___2 ~ "Homa Bay TRH",
            ref_where___3 ~ "Siaya TRH",
            ref_where___4 ~ "Kisumu CRH",
            ref_where___5 ~ "Other")
    ) %>% 
    add_n() %>% 
    bold_labels()%>% 
    as_gt() %>%
  # modify with gt functions
  gt::tab_header("Where do you normally refer women to") %>% 
  gt::tab_options(
    table.font.size = "medium",
    data_row.padding = gt::px(1))
```


## Referral and monitor remission prioritization

### Barriers

```{r refremis_barrier_hcw, echo=F, warning=F, message=F}
refremis_barrier <- refremis_hcw %>% 
  select(record_id, matches("barr|add")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99))) %>% 
  mutate(refremis_add_knowledge = refmis_add_knowledge) %>% 
  mutate(refremis_add_tool = refmis_add_tool) %>% 
  mutate(refremis_add_workload = refmis_add_workload) %>% 
  select(-refmis_add_knowledge, -refmis_add_tool, -refmis_add_workload)

long_data <- refremis_barrier %>%
  pivot_longer(cols = -c(record_id,ref_barrier_other),
               names_to = c("type", "barrier"), 
               names_pattern = "refremis_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "Not applicable" ~ NA_real_,
                               value == "Not at all addressable" | value == "Not at all" ~ 1,
                               value == "Somewhat addressable" | value == "A little" ~ 2,
                               value == "Addressable" | value == "Somewhat" ~ 3,
                               value == "Very addressable" | value == "Very much" ~ 4))

stats <- long_data %>%
  group_by(barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_importance = mean_value_barr,
    se_importance = se_value_barr,
    mean_addressability = mean_value_add,
    se_addressability = se_value_add
  ) %>% 
  mutate(se_average = (se_importance + se_addressability)/2)

cutoff_importance <- long_data %>% 
  filter(type == "barrier") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_addressability <- long_data %>% 
  filter(type == "add") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- stats %>% 
  mutate(barrier_detail = dplyr::recode(barrier, 
                                        "guideline" =	"Guideline: Lack of guidelines",
                                        "hcwstigma" = "HCWstigma: HCW stigmatization of patients with mental illnesses",
                                        "track" = "Track: Lack of systems to track PMAD treatment",
                                        "relative" = "Relative: Patients being influenced by relatives not to go for the referral",
                                        "transport" = "Transport: Patients' lack of transport\n to attend the referral/remission assessments",
                                        "stigma" = "Stigma: Stigma from the community",
                                        "honor" = "Honor: Patients do not honor the referral\n or remission assessment visits they have been given",
                                  "knowledge" = "Knowledge: Insufficient training or knowledge gap for HCWs",
                                   "tool" = 	"Tool: Lack of standard tools",
                                  "workload" = "Workload: Having too many clients to see"))

ggplot(stats, aes(x = mean_importance, y = mean_addressability)) +
  geom_point(aes(color = barrier_detail, size = se_average), shape =1) + 
  scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
  scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
  geom_hline(yintercept = cutoff_addressability, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
  annotate("text", x = cutoff_importance, y = 4, label = paste0("Cutoff: ", round(cutoff_importance, 2)), hjust = -0.1) +
  annotate("text", x = 1, y = cutoff_addressability, label = paste0("Cutoff: ", round(cutoff_addressability, 2)), vjust = -1) +
  labs(title = "Barrier prioritization for referral and remission assessment",
       x = "Importance",
       y = "Addressability",
       color = "Barrier detail",
       size = "Average SE") +
  geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol = 2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))

```

### Strategies

```{r refremis_stra_hcw, echo=F, warning=F, message=F}
refremis_strategy <- refremis_hcw %>% 
  select(record_id, matches("stra|diff")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- refremis_strategy %>%
  pivot_longer(cols = -c(record_id, ref_stra_other, ref_where_hiv_diff,
                         ref_where_diff_hiv___1, ref_where_diff_hiv___2,
                         ref_where_diff_hiv___3, ref_where_diff_hiv___4,
                         ref_where_diff_hiv___5, ref_diff_other),
               names_to = c("type", "strategy"), 
               names_pattern = "refremis_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "I don't know" ~ NA_real_,
                               value == "Very hard" | value == "Major negative impact" ~ 1,
                               value == "Somewhat hard" | value == "Some negative impact" ~ 2,
                               value == "Neurtral" | value == "No impact" ~ 3,
                               value == "Somewhat easy" | value == "Some positive impact" ~ 4,
                               value == "Very easy" | value == "Major positive impact" ~ 5))

cutoff_impact <- long_data %>% 
  filter(type == "diff") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_feasiblity <- long_data %>% 
  filter(type == "stra") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- long_data %>%
  group_by(strategy, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_feasibility = mean_value_stra,
    se_feasibility = se_value_stra,
    mean_impact= mean_value_diff,
    se_impact = se_value_diff
  ) %>% 
  mutate(se_average = (se_feasibility + se_impact)/2)

stats <- stats %>% 
  mutate(strategy_detail = dplyr::recode(strategy, 
                                  "knowledge" = "Knowledge: Provide training for existing HCWs",
                                  "chv" = "CHV: Involve CHVs to aid in completion of referral",
                                   "guideline" =	"Guideline: Provide guidelines for HCWs",
                                   "tool" = 	"Tool: Provide standardized tools for HCWs",
                                  "home" = "Home: Conduct home visits to participants"))

ggplot(stats, aes(x = mean_impact, y = mean_feasibility)) +
  geom_point(aes(color = strategy_detail, size = se_average), shape =1) +
  scale_x_continuous(breaks = 1:5, limits = c(4.5, 5)) +
  scale_y_continuous(breaks = 1:5, limits = c(1, 5)) +
  geom_hline(yintercept = cutoff_feasiblity, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_impact, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_impact, y = 5, label = paste0("Cutoff: ", round(cutoff_impact, 2)), hjust = -0.1) +
  annotate("text", x = 4.52, y = cutoff_feasiblity, label = paste0("Cutoff: ", round(cutoff_feasiblity, 2)), vjust = -1) +
  labs(title = "Strategy prioritization for referral & remission assessment",
       x = "Impact",
       y = "Feasibility",
       color = "Strategy detail",
       size = "Average SE") +
  geom_text_repel(aes(label = strategy, color = strategy_detail),size = 4) + 
  guides(size=F, color = guide_legend(ncol=2,override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```


# IPMH

## Screening prioritization

### Barriers

```{r screen_barrier_ipmh, echo=F, warning=F, message=F}
ipmh_hcw <- data %>% select(record_id, starts_with("ipmh_"))

ipmh_screen <- ipmh_hcw %>% select(record_id,starts_with("ipmh_scre_"))

ipmh_screen_barrier <- ipmh_screen %>% 
  select(record_id, matches("bar|add")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- ipmh_screen_barrier %>%
  pivot_longer(cols = -c(record_id, ipmh_scre_barrier_other),
               names_to = c("type", "barrier"), 
               names_pattern = "ipmh_scre_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "Not applicable" ~ NA_real_,
                               value == "Not at all addressable" | value == "Not at all" ~ 1,
                               value == "Somewhat addressable" | value == "A little" ~ 2,
                               value == "Addressable" | value == "Somewhat" ~ 3,
                               value == "Very addressable" | value == "Very much" ~ 4))

stats <- long_data %>%
  group_by(barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_importance = mean_value_bar,
    se_importance = se_value_bar,
    mean_addressability = mean_value_add,
    se_addressability = se_value_add
  ) %>% 
  mutate(se_average = (se_importance + se_addressability)/2)

cutoff_importance <- long_data %>% 
  filter(type == "bar") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_addressability <- long_data %>% 
  filter(type == "add") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- stats %>% 
  mutate(barrier_detail = dplyr::recode(barrier, 
                                        "reach" = "Reach: Lay providers do not reach\n all PPW coming to the facility",
                                        "workload" = "Workload: Increased staff workload",
                                        "staff" = "Staff: Shortage of staff",
                                        "incentive" = "Incentive: Lack of financial incentives to motivate HCW",
                                        "flow" = "Flow: Complex flow from screening to getting PM+, \nleading to loss of patients",
                                        "confi" = "Confi: Fear of breach of confidentiality",
                                        "long" = "Long: Lengthening of patient visits",
                                        "partner" = "Partner: Lack of partner involvement"))
                                        

p_all <- ggplot(stats, aes(x = mean_importance, y = mean_addressability)) +
  geom_point(aes(color = barrier_detail, size = se_average), shape =1) + 
  scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
  scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
  geom_hline(yintercept = cutoff_addressability, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
  annotate("text", x = cutoff_importance, y = 4, label = paste0("Cutoff: ", round(cutoff_importance, 2)), hjust = -0.1) +
  annotate("text", x = 1.1, y = cutoff_addressability, label = paste0("Cutoff: ", round(cutoff_addressability, 2)), vjust = -1) +
  labs(title = "Barrier prioritization for IPMH screening",
       x = "Importance",
       y = "Addressability",
       color = "Barrier detail",
       size = "Average SE") +
  geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol = 2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))

```


```{r subgroup analysis}
# --- 1) Subset IPMH items ---
ipmh_hcw <- data %>% 
  select(record_id, starts_with("ipmh_"), starts_with("hcw_job___"))

ipmh_screen <- ipmh_hcw %>% 
  select(record_id, starts_with("ipmh_scre_"), starts_with("hcw_job___"))

# --- 2) Create hcw_job and provider_type (lay vs formally trained) ---
ipmh_screen <- ipmh_screen %>%
  mutate(
    hcw_job = case_when(
      hcw_job___1  == "Checked" ~ "Medical officer",
      hcw_job___2  == "Checked" ~ "Psychiatrists",
      hcw_job___3  == "Checked" ~ "Obstetrician/gynaecologist",
      hcw_job___4  == "Checked" ~ "Clinical officer",
      hcw_job___5  == "Checked" ~ "Nurses",
      hcw_job___6  == "Checked" ~ "Psychologist",
      hcw_job___7  == "Checked" ~ "Mental health social worker",
      hcw_job___8  == "Checked" ~ "Other social worker",
      hcw_job___9  == "Checked" ~ "HTS counsellor",
      hcw_job___10 == "Checked" ~ "Community health worker",
      hcw_job___11 == "Checked" ~ "Mentor mother",
      hcw_job___12 == "Checked" ~ "Other",
      TRUE ~ NA_character_
    ),
    hcw_job = fct_relevel(
      factor(hcw_job),
      "Medical officer", "Psychiatrists", "Obstetrician/gynaecologist",
      "Clinical officer", "Nurses", "Psychologist",
      "Mental health social worker", "Other social worker",
      "HTS counsellor", "Community health worker", "Mentor mother", "Other"
    ),
    provider_type = case_when(
      hcw_job %in% c("HTS counsellor", "Mentor mother") ~ "Lay providers",
      !is.na(hcw_job) ~ "Formally trained providers",
      TRUE ~ NA_character_
    ),
    provider_type = factor(provider_type,
                           levels = c("Lay providers", "Formally trained providers"))
  )

# --- 3) Barrier dataset + missing handling (99) ---
ipmh_screen_barrier <- ipmh_screen %>% 
  select(record_id, provider_type, ipmh_scre_barrier_other, matches("ipmh_scre_.*(bar|add).*")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

# --- 4) Long format + harmonize response options ---
long_data <- ipmh_screen_barrier %>%
  pivot_longer(
    cols = -c(record_id, provider_type, ipmh_scre_barrier_other),
    names_to = c("type", "barrier"),
    names_pattern = "ipmh_scre_(.*)_(.*)"
  ) %>%
  mutate(
    value_1 = case_when(
      value == "Not applicable" ~ NA_real_,
      value %in% c("Not at all addressable", "Not at all") ~ 1,
      value %in% c("Somewhat addressable", "A little") ~ 2,
      value %in% c("Addressable", "Somewhat") ~ 3,
      value %in% c("Very addressable", "Very much") ~ 4,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(provider_type))  # keep only records with a provider type

# --- 5) Subgroup stats (means and SEs by provider_type) ---
stats_subgroup <- long_data %>%
  group_by(provider_type, barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value   = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    n_nonmiss  = sum(!is.na(value_1)),
    .groups    = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value, n_nonmiss)) %>%
  rename(
    mean_importance     = mean_value_bar,
    se_importance       = se_value_bar,
    n_importance        = n_nonmiss_bar,
    mean_addressability = mean_value_add,
    se_addressability   = se_value_add,
    n_addressability    = n_nonmiss_add
  ) %>%
  mutate(se_average = (se_importance + se_addressability) / 2) %>%
  mutate(
    barrier_detail = dplyr::recode(
      barrier,
      "reach"     = "Reach: Lay providers do not reach\nall PPW coming to the facility",
      "workload"  = "Workload: Increased staff workload",
      "staff"     = "Staff: Shortage of staff",
      "incentive" = "Incentive: Lack of financial incentives to motivate HCW",
      "flow"      = "Flow: Complex flow from screening to getting PM+,\nleading to loss of patients",
      "confi"     = "Confi: Fear of breach of confidentiality",
      "long"      = "Long: Lengthening of patient visits",
      "partner"   = "Partner: Lack of partner involvement",
      .default    = barrier
    )
  )

# --- 6) Plot function (subgroup-specific cutoffs) ---
plot_prioritization <- function(df, title_text) {

  cutoff_importance <- mean(df$mean_importance, na.rm = TRUE)
  cutoff_address    <- mean(df$mean_addressability, na.rm = TRUE)

  ggplot(df, aes(x = mean_importance, y = mean_addressability)) +
    geom_point(aes(color = barrier_detail, size = se_average), shape = 1) +
    geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) +
    scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
    scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
    geom_hline(yintercept = cutoff_address, linetype = "dashed", color = "grey") +
    geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_importance, y = 4,
             label = paste0("Cutoff: ", round(cutoff_importance, 2)),
             hjust = -0.1, size = 3.5) +
    annotate("text", x = 1.1, y = cutoff_address,
             label = paste0("Cutoff: ", round(cutoff_address, 2)),
             vjust = -1, size = 3.5) +
    labs(
      title = title_text,
      x = "Importance",
      y = "Addressability",
      color = "Barrier detail",
      size = "Average SE"
    ) +
    guides(
      size = "none",
      color = guide_legend(ncol = 2, override.aes = list(shape = 16, size = 6))
    ) +
    theme_minimal() +
    theme(
      axis.text.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      axis.title.y = element_text(size = 12, face = "bold"),
      axis.title.x = element_text(size = 12, face = "bold"),
      plot.title = element_text(size = 18, face = "bold"),
      legend.text = element_text(size = 10),
      legend.direction = "vertical",
      legend.position = "bottom",
      plot.margin = margin(1, 1, 1, 1, "cm")
    )
}

# --- 7) Two subgroup plots ---
p_lay <- plot_prioritization(
  stats_subgroup %>% filter(provider_type == "Lay providers"),
  "Barrier prioritization for IPMH screening: Lay providers"
)

p_formal <- plot_prioritization(
  stats_subgroup %>% filter(provider_type == "Formally trained providers"),
  "Barrier prioritization for IPMH screening: Formally trained providers"
)

p_lay
p_formal
```


### Strategies

```{r screen_stra_ipmh, echo=F, warning=F, message=F}
ipmh_screen_strategy <- ipmh_screen %>% 
  select(record_id, matches("stra|diff")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- ipmh_screen_strategy %>%
  pivot_longer(cols = -c(record_id, ipmh_scre_strategy_other),
               names_to = c("type", "strategy"), 
               names_pattern = "ipmh_scre_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "I don't know" ~ NA_real_,
                               value == "Very hard" | value == "Major negative impact" ~ 1,
                               value == "Somewhat hard" | value == "Some negative impact" ~ 2,
                               value == "Neurtral" | value == "No impact" ~ 3,
                               value == "Somewhat easy" | value == "Some positive impact" ~ 4,
                               value == "Very easy" | value == "Major positive impact" ~ 5))

long_data <- long_data %>%
  mutate(strategy = ifelse(strategy == "plan", "streamline", strategy))

cutoff_impact <- long_data %>% 
  filter(type == "diff") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_feasiblity <- long_data %>% 
  filter(type == "stra") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- long_data %>%
  group_by(strategy, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_feasibility = mean_value_stra,
    se_feasibility = se_value_stra,
    mean_impact= mean_value_diff,
    se_impact = se_value_diff
  ) %>% 
  mutate(se_average = (se_feasibility + se_impact)/2)

stats <- stats %>% 
  mutate(strategy_detail = dplyr::recode(strategy, 
                                         "nurse" = "Nurse: Have the nurses screen at 1st contact",
                                         "room" = "Room: Provide a specific area for screening at the facility",
                                         "incentive" = "Incentive: Provide financial incentives to HCWs",
                                         "trainall" = "Trainall: Train all HCWs",
                                         "streamline" = "Streamline: Streamline workflow at the facility",
                                         "chv" = "CHV: Involve community health promoters",
                                         "partner" = "Partner: Encourage male partner involvement",
                                         "info" = "Info: Provide IPMH information and \nreassurance at the triage desk"))

ggplot(stats, aes(x = mean_impact, y = mean_feasibility)) +
  geom_point(aes(color = strategy_detail, size = se_average), shape =1) +
  scale_x_continuous(breaks = 1:5, limits = c(4, 5)) +
  scale_y_continuous(breaks = 1:5, limits = c(1, 5)) +
  geom_hline(yintercept = cutoff_feasiblity, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_impact, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_impact, y = 5, label = paste0("Cutoff: ", round(cutoff_impact, 2)), hjust = -0.1) +
  annotate("text", x = 4.05, y = cutoff_feasiblity, label = paste0("Cutoff: ", round(cutoff_feasiblity, 2)), vjust = -1) +
  labs(title = "Strategy prioritization for IPMH screening",
       x = "Impact",
       y = "Feasibility",
       color = "Strategy detail",
       size = "Average SE") +
  geom_text_repel(aes(label = strategy, color = strategy_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol =2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```

## PM+ prioritization

### Barriers

```{r pm_barrier_ipmh, echo=F, warning=F, message=F}
ipmh_pm <- ipmh_hcw %>% select(record_id,starts_with("ipmh_trt_"))

ipmh_pm_barrier <- ipmh_pm %>% 
  select(record_id, matches("bar|add")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99))) 

long_data <- ipmh_pm_barrier %>%
  pivot_longer(cols = -c(record_id, ipmh_trt_barrier_other),
               names_to = c("type", "barrier"), 
               names_pattern = "ipmh_trt_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "Not applicable" ~ NA_real_,
                               value == "Not at all addressable" | value == "Not at all" ~ 1,
                               value == "Somewhat addressable" | value == "A little" ~ 2,
                               value == "Addressable" | value == "Somewhat" ~ 3,
                               value == "Very addressable" | value == "Very much" ~ 4))

stats <- long_data %>%
  group_by(barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_importance = mean_value_bar,
    se_importance = se_value_bar,
    mean_addressability = mean_value_add,
    se_addressability = se_value_add
  ) %>% 
  mutate(se_average = (se_importance + se_addressability)/2)

cutoff_importance <- long_data %>% 
  filter(type == "bar") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_addressability <- long_data %>% 
  filter(type == "add") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- stats %>% 
  mutate(barrier_detail = dplyr::recode(barrier, 
                                        "workload" = "Workload: Increased workload for lay providers",
                                        "staff" = "Staff: Shortage of staff",
                                        "incentive" = "Incentive: Lack of financial incentives to motivate HCWs",
                                        "flow" = "Flow: Complex flow from pming to getting PM+, \nleading to loss of patients",
                                        "prefer" = "Prefer: Patients prefer to deal with\n one HCW as opposed to many",
                                        "confi" = "Confi: Fear of breach of confidentiality",
                                        "long" = "Long: Lengthening of patient visits",
                                        "partner" = "Partner: Lack of partner involvement"))

ggplot(stats, aes(x = mean_importance, y = mean_addressability)) +
  geom_point(aes(color = barrier_detail, size = se_average), shape =1) + 
  scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
  scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
  geom_hline(yintercept = cutoff_addressability, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
  annotate("text", x = cutoff_importance, y = 4, label = paste0("Cutoff: ", round(cutoff_importance, 2)), hjust = -0.1) +
  annotate("text", x = 1.1, y = cutoff_addressability, label = paste0("Cutoff: ", round(cutoff_addressability, 2)), vjust = -1) +
  labs(title = "Barrier prioritization for IPMH PM+",
       x = "Importance",
       y = "Addressability",
       color = "Barrier detail",
       size = "Average SE") +
  geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol=2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))

```

### Strategies

```{r pm_stra_ipmh, echo=F, warning=F, message=F}
ipmh_pm_strategy <- ipmh_pm %>% 
  mutate(ipmh_trt_diff_stream = ipmh_trt_diff_streami) %>% 
  select(-ipmh_trt_diff_streami) %>% 
  select(record_id, matches("stra|diff")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))
  
long_data <- ipmh_pm_strategy %>%
  pivot_longer(cols = -c(record_id, ipmh_trt_strategy_other),
               names_to = c("type", "strategy"), 
               names_pattern = "ipmh_trt_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "I don't know" ~ NA_real_,
                               value == "Very hard" | value == "Major negative impact" ~ 1,
                               value == "Somewhat hard" | value == "Some negative impact" ~ 2,
                               value == "Neurtral" | value == "No impact" ~ 3,
                               value == "Somewhat easy" | value == "Some positive impact" ~ 4,
                               value == "Very easy" | value == "Major positive impact" ~ 5))
cutoff_impact <- long_data %>% 
  filter(type == "diff") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_feasiblity <- long_data %>% 
  filter(type == "stra") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- long_data %>%
  group_by(strategy, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_feasibility = mean_value_stra,
    se_feasibility = se_value_stra,
    mean_impact= mean_value_diff,
    se_impact = se_value_diff
  ) %>% 
  mutate(se_average = (se_feasibility + se_impact)/2)

stats <- stats %>% 
  mutate(strategy_detail = dplyr::recode(strategy, 
                                         "traincli" = "Traincli: Train cliniains on all IPMH processes",
                                         "clin" = "Clin: Have clinicians in charge of PM+ instead of lay providers",
                                         "stream" = "Stream: Streamline the workflow at the facility",
                                         "incentive" = "Incentive: Provide financial incentives to HCWs",
                                         "chv" = "CHV: Involve community health promoters",
                                         "partner" = "Partner: Encourage male partner involvement",
                                         "info" = "Info: Provide IPMH information and reassurance \nat the triage desk"))

ggplot(stats, aes(x = mean_impact, y = mean_feasibility)) +
  geom_point(aes(color = strategy_detail, size = se_average), shape =1) +
  scale_x_continuous(breaks = 1:5, limits = c(4.5, 5)) +
  scale_y_continuous(breaks = 1:5, limits = c(1, 5)) +
  geom_hline(yintercept = cutoff_feasiblity, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_impact, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_impact, y = 5, label = paste0("Cutoff: ", round(cutoff_impact, 2)), hjust = -0.1) +
  annotate("text", x = 4.51, y = cutoff_feasiblity, label = paste0("Cutoff: ", round(cutoff_feasiblity, 2)), vjust = -1) +
  labs(title = "Strategy prioritization for IPMH PM+",
       x = "Impact",
       y = "Feasibility",
       color = "Strategy detail",
       size = "Average SE") +
  geom_text_repel(aes(label = strategy, color = strategy_detail), size = 4) + 
  guides(size=F, color = guide_legend(override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```

## Telepsychiatry prioritization

### Barriers

```{r telepsy_barrier_ipmh, echo=F, warning=F, message=F}
ipmh_telepsy <- ipmh_hcw %>% select(record_id,starts_with("ipmh_telepsy_"))

ipmh_telepsy_barrier <- ipmh_telepsy %>% 
  select(record_id, matches("bar|add")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))

long_data <- ipmh_telepsy_barrier %>%
  pivot_longer(cols = -c(record_id, ipmh_telepsy_barrier_other),
               names_to = c("type", "barrier"), 
               names_pattern = "ipmh_telepsy_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "Not applicable" ~ NA_real_,
                               value == "Not at all addressable" | value == "Not at all" ~ 1,
                               value == "Somewhat addressable" | value == "A little" ~ 2,
                               value == "Addressable" | value == "Somewhat" ~ 3,
                               value == "Very addressable" | value == "Very much" ~ 4))
cutoff_importance <- long_data %>% 
  filter(type == "bar") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_addressability <- long_data %>% 
  filter(type == "add") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- long_data %>%
  group_by(barrier, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_importance = mean_value_bar,
    se_importance = se_value_bar,
    mean_addressability = mean_value_add,
    se_addressability = se_value_add
  ) %>% 
  mutate(se_average = (se_importance + se_addressability)/2)


stats <- stats %>% 
  mutate(barrier_detail = dplyr::recode(barrier, 
                                        "sche" = "Sche: Complex scheduling process of telepsychiatry",
                                        "drug" = "Drug: Inadequate or lack of access \n to the medication prescribed",
                                        "setup" = "Setup: User challenges in setting \n up and using telepsychiatry",
                                        "internet" = "Internet: Internet connectivity for telepsychiatry",
                                        "port" = "Port: Portability of the device \n used for telepsychiatry",
                                        "gadget" = "Gadget: Lack of required gadgets \nto conduct telepsychiatry",
                                        "inte" = "Inte: Challenging process of integration\n with the care at the facility",
                                        "language" = "Language: Language barrier \n between women and psychiatrists",
                                        "confi" = "Confi: Fear of breach of confidentiality",
                                        "physical" = "Physical: Clients' preference to talk to psychiatrists \nin person instead of online"))

ggplot(stats, aes(x = mean_importance, y = mean_addressability)) +
  geom_point(aes(color = barrier_detail, size = se_average), shape =1) + 
  scale_x_continuous(breaks = 1:4, limits = c(1, 4)) +
  scale_y_continuous(breaks = 1:4, limits = c(1, 4)) +
    geom_hline(yintercept = cutoff_addressability, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_importance, linetype = "dashed", color = "grey") +
  annotate("text", x = cutoff_importance, y = 4, label = paste0("Cutoff: ", round(cutoff_importance, 2)), hjust = -0.1) +
  annotate("text", x = 1.1, y = cutoff_addressability, label = paste0("Cutoff: ", round(cutoff_addressability, 2)), vjust = -1) +
  labs(title = "Barrier prioritization for IPMH telepsychiatry",
       x = "Importance",
       y = "Addressability",
       color = "Barrier detail",
       size = "Average SE") +
  geom_text_repel(aes(label = barrier, color = barrier_detail), size = 4) + 
  guides(size=F, color = guide_legend(ncol =2, override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))

```

### Strategies

```{r telepsy_stra_ipmh, echo=F, warning=F, message=F}
ipmh_telepsy_strategy <- ipmh_telepsy %>% 
  select(record_id, matches("stra|diff")) %>%
  mutate(across(where(is.numeric), ~ na_if(., 99)))
  
long_data <- ipmh_telepsy_strategy %>%
  pivot_longer(cols = -c(record_id, ipmh_telepsy_stra_other),
               names_to = c("type", "strategy"), 
               names_pattern = "ipmh_telepsy_(.*)_(.*)") %>% 
    mutate(value_1 = case_when(value == "I don't know" ~ NA_real_,
                               value == "Very hard" | value == "Major negative impact" ~ 1,
                               value == "Somewhat hard" | value == "Some negative impact" ~ 2,
                               value == "Neurtral" | value == "No impact" ~ 3,
                               value == "Somewhat easy" | value == "Some positive impact" ~ 4,
                               value == "Very easy" | value == "Major positive impact" ~ 5))

stats <- long_data %>%
  group_by(strategy, type) %>%
  summarise(
    mean_value = mean(value_1, na.rm = TRUE),
    se_value = sd(value_1, na.rm = TRUE) / sqrt(sum(!is.na(value_1))),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = type, values_from = c(mean_value, se_value)) %>%
  rename(
    mean_feasibility = mean_value_stra,
    se_feasibility = se_value_stra,
    mean_impact= mean_value_diff,
    se_impact = se_value_diff
  ) %>% 
  mutate(se_average = (se_feasibility + se_impact)/2)

cutoff_impact <- long_data %>% 
  filter(type == "diff") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)
cutoff_feasiblity <- long_data %>% 
  filter(type == "stra") %>% 
  summarise(mean_value = mean(value_1, na.rm = TRUE)) %>% 
  pull(mean_value)

stats <- stats %>% 
  mutate(strategy_detail = dplyr::recode(strategy, 
                                         "align" = "Align: Align psychiatry appointments with routine clinic visits",
                                         "mm" = "MM: Have mentor mothers sit in during telepsychiatry",
                                         "lang" = "Lang: Involve translators for language barrier or those who are deaf",
                                         "partner" = "Partner: Have a support partner during telepsychiatry",
                                         "nurse" = "Nurse: Involve nurses and clinicians during telepsychiatry"))

ggplot(stats, aes(x = mean_impact, y = mean_feasibility )) +
  geom_point(aes(color = strategy_detail, size = se_average), shape =1) +
  scale_x_continuous(breaks = 1:5, limits = c(4.5, 5)) +
  scale_y_continuous(breaks = 1:5, limits = c(1, 5)) +
  geom_hline(yintercept = cutoff_feasiblity, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = cutoff_impact, linetype = "dashed", color = "grey") +
    annotate("text", x = cutoff_impact, y = 5, label = paste0("Cutoff: ", round(cutoff_impact, 2)), hjust = -0.1) +
  annotate("text", x = 4.51, y = cutoff_feasiblity, label = paste0("Cutoff: ", round(cutoff_feasiblity, 2)), vjust = -1) +
  labs(title = "Strategy prioritization for IPMH telepsychiatry",
       x = "Impact",
       y = "Feasibility",
       color = "Strategy detail",
       size = "Average SE") +
  geom_text_repel(aes(label = strategy, color = strategy_detail), size = 4) + 
  guides(size=F, color = guide_legend(override.aes = list(shape = 16, size = 6)))+
  theme_minimal() + 
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 10),
        legend.direction = "vertical",
        legend.position = "bottom",
        plot.margin = margin(1, 1, 1, 1, "cm"))
```


